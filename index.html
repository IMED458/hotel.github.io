<!DOCTYPE html>
<html lang="ka" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hotel Admin System</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Noto Sans Georgian', 'sans-serif']
          },
          colors: {
            primary: '#0ea5e9',
            secondary: '#64748b',
            success: '#22c55e',
            warning: '#f59e0b',
            danger: '#ef4444',
            dark: '#0f172a'
          }
        }
      }
    };
  </script>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    .app-wrapper { min-height: 100%; overflow: auto; }
    .sidebar { width: 280px; }
    .main-content { margin-left: 280px; }
    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; transition: transform .2s ease; }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0; }
    }
    .toast { animation: slideIn .25s ease; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .modal-overlay { animation: fadeIn .2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .timeline-head, .timeline-row { display: grid; grid-template-columns: 160px repeat(var(--days-in-month), 28px); }
    .timeline-head { position: sticky; top: 0; z-index: 3; }
    .timeline-cell { border-right: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; min-height: 42px; font-size: 11px; display: flex; align-items: center; justify-content: center; }
    .timeline-room { position: sticky; left: 0; z-index: 2; background: #f8fafc; font-size: 12px; padding: 0 8px; justify-content: flex-start; font-weight: 600; }
    .timeline-row { position: relative; }
    .reservation-bar { position: absolute; top: 5px; height: 32px; border-radius: 8px; padding: 0 8px; display: flex; align-items: center; font-size: 11px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 100%, 0 100%); }
    .reservation-bar.reserved { background: #dbeafe; border: 1px solid #60a5fa; color: #1e3a8a; }
    .reservation-bar.checkedin { background: #dcfce7; border: 1px solid #4ade80; color: #14532d; }
    .reservation-bar.checkout { background: #fee2e2; border: 1px solid #f87171; color: #7f1d1d; }
    .consent-print { padding: 18px; border: 1px solid #d1d5db; font-size: 13px; line-height: 1.5; }
  </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 font-sans text-gray-800 dark:text-gray-100">
  <div class="app-wrapper flex">
    <aside id="sidebar" class="sidebar fixed h-full bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 shadow-sm flex flex-col">
      <div class="p-6 border-b border-gray-100 dark:border-gray-700">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-sky-500 to-blue-600 rounded-xl flex items-center justify-center text-white">ğŸ¨</div>
          <div>
            <h1 id="hotel-name-display" class="font-bold text-lg text-gray-900 dark:text-white">Grand Hotel</h1>
            <p class="text-xs text-gray-500">Admin System</p>
          </div>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-1 overflow-y-auto" id="main-nav"></nav>

      <div class="p-4 border-t border-gray-100 dark:border-gray-700">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-violet-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-semibold">A</div>
          <div class="flex-1">
            <p class="font-medium text-sm text-gray-900 dark:text-white">áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒ¢áƒáƒ áƒ˜</p>
            <p class="text-xs text-gray-500">admin@hotel.ge</p>
          </div>
          <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <span id="theme-icon">ğŸŒ™</span>
          </button>
        </div>
      </div>
    </aside>

    <main class="main-content flex-1 min-h-full">
      <header class="sticky top-0 z-40 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg border-b border-gray-200 dark:border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">â˜°</button>
            <input id="global-search" type="text" placeholder="áƒ«áƒ”áƒ‘áƒœáƒ..." class="px-4 py-2.5 w-64 bg-gray-100 dark:bg-gray-700 border-0 rounded-xl text-sm focus:ring-2 focus:ring-sky-500">
          </div>
          <div class="flex items-center gap-3">
            <button onclick="openModal('new-reservation')" class="px-4 py-2.5 bg-gradient-to-r from-sky-500 to-blue-600 text-white rounded-xl text-sm font-medium">áƒáƒ®áƒáƒšáƒ˜ áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜</button>
            <button class="p-2.5 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700">ğŸ””</button>
          </div>
        </div>
      </header>

      <div id="page-content" class="p-6 space-y-6">
        <section id="page-dashboard" class="page-section"></section>
        <section id="page-calendar" class="page-section hidden"></section>
        <section id="page-rooms" class="page-section hidden"></section>
        <section id="page-reservations" class="page-section hidden"></section>
        <section id="page-guests" class="page-section hidden"></section>
        <section id="page-checkin" class="page-section hidden"></section>
        <section id="page-payments" class="page-section hidden"></section>
        <section id="page-housekeeping" class="page-section hidden"></section>
        <section id="page-pricing" class="page-section hidden"></section>
        <section id="page-channels" class="page-section hidden"></section>
        <section id="page-reports" class="page-section hidden"></section>
        <section id="page-settings" class="page-section hidden"></section>
      </div>
    </main>
  </div>

  <div id="modal-container" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0 bg-black/50" onclick="closeModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden max-h-[90%] flex flex-col">
      <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
        <h3 id="modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">áƒ¤áƒáƒ áƒ›áƒ</h3>
        <button onclick="closeModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">âœ•</button>
      </div>
      <div id="modal-content" class="p-6 overflow-y-auto flex-1"></div>
    </div>
  </div>

  <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <script>
    const NAV_ITEMS = [
      ['dashboard', 'áƒ“áƒ”áƒ¨áƒ‘áƒáƒ áƒ“áƒ˜'], ['calendar', 'áƒ™áƒáƒšáƒ”áƒœáƒ“áƒáƒ áƒ˜ / Timeline'], ['rooms', 'áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ˜'], ['reservations', 'áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜'],
      ['guests', 'áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ”áƒ‘áƒ˜'], ['checkin', 'Check-in / Check-out'], ['payments', 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜ / áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ”áƒ‘áƒ˜'],
      ['housekeeping', 'Housekeeping'], ['pricing', 'áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜ / áƒ¢áƒáƒ áƒ˜áƒ¤áƒ”áƒ‘áƒ˜'], ['channels', 'Channel Manager'],
      ['reports', 'áƒ áƒ”áƒáƒáƒ áƒ¢áƒ”áƒ‘áƒ˜'], ['settings', 'áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜']
    ];

    const defaultConfig = {
      hotel_name: 'Grand Hotel',
      hotel_email: 'info@hotel.ge',
      hotel_phone: '+995 32 123 4567',
      hotel_address: 'áƒ áƒ£áƒ¡áƒ—áƒáƒ•áƒ”áƒšáƒ˜áƒ¡ áƒ’áƒáƒ›áƒ–áƒ˜áƒ áƒ˜ 1, áƒ—áƒ‘áƒ˜áƒšáƒ˜áƒ¡áƒ˜',
      currency_symbol: 'â‚¾',
      primary_color: '#0ea5e9',
      background_color: '#f8fafc',
      text_color: '#1e293b',
      accent_color: '#8b5cf6'
    };

    const DEFAULT_CHANNEL_CONFIG = {
      connectionMode: 'oauth',
      proxyUrl: '',
      apiBaseUrl: 'https://staging.channex.io/api/v1',
      authStartUrl: '/auth/channex/start',
      authStatusUrl: '/auth/channex/status',
      apiKey: '',
      propertyId: '',
      autoSyncEnabled: true,
      syncIntervalMinutes: 15,
      isConnected: false,
      connectedAt: '',
      lastSyncAt: ''
    };

    let config = { ...defaultConfig };
    let allData = [];
    let currentPage = 'dashboard';
    let calendarDate = new Date();
    let calendarView = 'week';

    const dataHandler = {
      onDataChanged(data) {
        allData = Array.isArray(data) ? data : [];
        renderCurrentPage();
      }
    };

    function getChannelConfig() {
      try {
        return { ...DEFAULT_CHANNEL_CONFIG, ...(JSON.parse(localStorage.getItem('channelManagerConfig') || '{}')) };
      } catch {
        return { ...DEFAULT_CHANNEL_CONFIG };
      }
    }

    function setChannelConfig(next) {
      localStorage.setItem('channelManagerConfig', JSON.stringify({ ...getChannelConfig(), ...next }));
    }

    function showToast(message, type = 'success') {
      const c = document.getElementById('toast-container');
      const color = type === 'error' ? 'bg-red-600' : type === 'warning' ? 'bg-amber-500' : 'bg-emerald-600';
      const el = document.createElement('div');
      el.className = `toast ${color} text-white px-4 py-3 rounded-xl shadow-lg text-sm`;
      el.textContent = message;
      c.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    function formatDate(v) {
      if (!v) return '-';
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return '-';
      return d.toLocaleDateString('ka-GE');
    }

    function initNav() {
      const nav = document.getElementById('main-nav');
      nav.innerHTML = NAV_ITEMS.map(([id, label]) => `
        <button onclick="navigateTo('${id}')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700" data-page="${id}">${label}</button>
      `).join('');
    }

    function applyConfig() {
      document.getElementById('hotel-name-display').textContent = config.hotel_name || defaultConfig.hotel_name;
      document.documentElement.style.setProperty('--primary-color', config.primary_color || defaultConfig.primary_color);
    }

    function getHotelIdentity() {
      return {
        name: config.hotel_name || defaultConfig.hotel_name,
        email: config.hotel_email || defaultConfig.hotel_email,
        phone: config.hotel_phone || defaultConfig.hotel_phone,
        address: config.hotel_address || defaultConfig.hotel_address
      };
    }

    async function initialize() {
      initNav();
      ensureHotelState();
      config = { ...defaultConfig, ...getState('hotelConfig', {}) };
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            setState('hotelConfig', config);
            applyConfig();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              { get: () => cfg.primary_color || defaultConfig.primary_color, set: (v) => window.elementSdk.setConfig({ primary_color: v }) },
              { get: () => cfg.background_color || defaultConfig.background_color, set: (v) => window.elementSdk.setConfig({ background_color: v }) },
              { get: () => cfg.text_color || defaultConfig.text_color, set: (v) => window.elementSdk.setConfig({ text_color: v }) },
              { get: () => cfg.accent_color || defaultConfig.accent_color, set: (v) => window.elementSdk.setConfig({ accent_color: v }) }
            ],
            borderables: []
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['hotel_name', cfg.hotel_name || defaultConfig.hotel_name],
            ['currency_symbol', cfg.currency_symbol || defaultConfig.currency_symbol]
          ])
        });
      }

      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) console.error('Data SDK init failed');
      }

      await handleOAuthCallback();
      applyConfig();
      navigateTo('dashboard');
    }

    function navigateTo(page) {
      currentPage = page;
      document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
      const pageEl = document.getElementById(`page-${page}`);
      if (pageEl) pageEl.classList.remove('hidden');

      document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.remove('bg-sky-50', 'dark:bg-sky-900/20', 'text-sky-700', 'dark:text-sky-400');
        if (el.dataset.page === page) el.classList.add('bg-sky-50', 'dark:bg-sky-900/20', 'text-sky-700', 'dark:text-sky-400');
      });

      document.getElementById('sidebar').classList.remove('open');
      renderCurrentPage();
    }

    function renderCurrentPage() {
      if (currentPage === 'dashboard') return renderDashboard();
      if (currentPage === 'calendar') return renderCalendar();
      if (currentPage === 'rooms') return renderRooms();
      if (currentPage === 'reservations') return renderReservations();
      if (currentPage === 'guests') return renderGuests();
      if (currentPage === 'checkin') return renderCheckin();
      if (currentPage === 'payments') return renderPayments();
      if (currentPage === 'housekeeping') return renderHousekeeping();
      if (currentPage === 'pricing') return renderPricing();
      if (currentPage === 'channels') return renderChannels();
      if (currentPage === 'reports') return renderReports();
      if (currentPage === 'settings') return renderSettings();
    }

    function formatDateISO(date) {
      const d = new Date(date);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }
    function parseISODateLocal(value) {
      if (!value || typeof value !== 'string') return null;
      const m = value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) {
        const d = new Date(value);
        return Number.isNaN(d.getTime()) ? null : d;
      }
      const y = Number(m[1]);
      const mo = Number(m[2]) - 1;
      const da = Number(m[3]);
      return new Date(y, mo, da, 12, 0, 0, 0);
    }
    function todayISO() {
      return formatDateISO(new Date());
    }
    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }
    function calculateNights(checkin, checkout) {
      const cin = parseISODateLocal(checkin);
      const cout = parseISODateLocal(checkout);
      if (!cin || !cout) return 1;
      return Math.max(1, Math.ceil((cout - cin) / (1000 * 60 * 60 * 24)));
    }
    function getRoomTypes() {
      return ['Single', 'Double', 'Triple', 'Family', 'Suite'];
    }
    function getState(key, fallback) {
      try {
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : fallback;
      } catch {
        return fallback;
      }
    }
    function setState(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }
    function ensureHotelState() {
      if (!Array.isArray(getState('rooms', null))) {
        const rooms = [];
        for (let i = 101; i <= 112; i++) {
          let roomType = 'Single';
          let basePrice = 120;
          if (i >= 105 && i <= 108) { roomType = 'Double'; basePrice = 170; }
          if (i >= 109 && i <= 110) { roomType = 'Triple'; basePrice = 220; }
          if (i === 111) { roomType = 'Family'; basePrice = 300; }
          if (i === 112) { roomType = 'Suite'; basePrice = 450; }
          rooms.push({
            id: i - 100,
            roomNumber: String(i),
            roomName: `Room ${i}`,
            roomType,
            basePrice,
            floor: Math.floor(i / 100),
            beds: roomType === 'Single' ? 1 : 2,
            maxGuests: roomType === 'Single' ? 1 : roomType === 'Double' ? 2 : roomType === 'Triple' ? 3 : 4,
            status: 'available'
          });
        }
        setState('rooms', rooms);
      }
      if (!Array.isArray(getState('reservations', null))) {
        const today = new Date();
        const reservations = [
          { id: 1, guestName: 'áƒ’áƒ˜áƒáƒ áƒ’áƒ˜ áƒ›áƒ”áƒšáƒáƒ«áƒ”', guestPhone: '555123456', guestEmail: 'giorgi@mail.ge', guestIdNumber: '01001000001', guestCitizenship: 'áƒ¡áƒáƒ¥áƒáƒ áƒ—áƒ•áƒ”áƒšáƒ', guestBirthDate: '1990-01-01', roomId: 1, checkinDate: formatDateISO(addDays(today, -1)), checkoutDate: formatDateISO(addDays(today, 2)), status: 'Checked-in', totalPrice: 360, paymentStatus: 'paid' },
          { id: 2, guestName: 'áƒáƒœáƒ áƒ¥áƒáƒ•áƒ—áƒáƒ áƒáƒ«áƒ”', guestPhone: '555777888', guestEmail: '', guestIdNumber: '01001000002', guestCitizenship: 'áƒ¡áƒáƒ¥áƒáƒ áƒ—áƒ•áƒ”áƒšáƒ', guestBirthDate: '1993-06-21', roomId: 6, checkinDate: formatDateISO(addDays(today, 1)), checkoutDate: formatDateISO(addDays(today, 4)), status: 'Reserved', totalPrice: 510, paymentStatus: 'partial' },
          { id: 3, guestName: 'Lars Holm', guestPhone: '+46 700 000 000', guestEmail: 'lars@sample.se', guestIdNumber: 'SE9988', guestCitizenship: 'Sweden', guestBirthDate: '1987-03-03', roomId: 12, checkinDate: formatDateISO(addDays(today, 3)), checkoutDate: formatDateISO(addDays(today, 5)), status: 'Reserved', totalPrice: 900, paymentStatus: 'unpaid' }
        ];
        setState('reservations', reservations);
        setState('nextReservationId', 4);
      }
      if (!Array.isArray(getState('guests', null))) setState('guests', []);
      if (!Array.isArray(getState('payments', null))) setState('payments', []);
      if (!getState('nextPaymentId', null)) setState('nextPaymentId', 1);
      if (!getState('monthlyRates', null)) {
        const rates = {};
        for (let m = 1; m <= 12; m++) rates[m] = { Single: 120, Double: 170, Triple: 220, Family: 300, Suite: 450 };
        setState('monthlyRates', rates);
      }
    }
    function getRoomsData() { return getState('rooms', []); }
    function setRoomsData(rooms) { setState('rooms', rooms); }
    function getReservationsData() { return getState('reservations', []); }
    function setReservationsData(items) { setState('reservations', items); }
    function getGuestsData() { return getState('guests', []); }
    function setGuestsData(items) { setState('guests', items); }
    function getPaymentsData() { return getState('payments', []); }
    function setPaymentsData(items) { setState('payments', items); }
    function getMonthlyRates() { return getState('monthlyRates', {}); }
    function findRoomById(id) { return getRoomsData().find(r => Number(r.id) === Number(id)); }
    function formatReservationStatus(s) { return s === 'Checked-in' ? 'checked-in' : s === 'Checked-out' ? 'checked-out' : s === 'Cancelled' ? 'cancelled' : 'confirmed'; }

    function statusBadge(status) {
      const map = {
        pending: 'bg-amber-100 text-amber-700',
        confirmed: 'bg-sky-100 text-sky-700',
        'checked-in': 'bg-violet-100 text-violet-700',
        'checked-out': 'bg-gray-100 text-gray-700',
        cancelled: 'bg-red-100 text-red-700',
        'no-show': 'bg-red-100 text-red-700'
      };
      return map[status] || 'bg-gray-100 text-gray-700';
    }

    function paymentBadge(status) {
      const map = {
        paid: 'bg-green-100 text-green-700',
        partial: 'bg-amber-100 text-amber-700',
        unpaid: 'bg-red-100 text-red-700'
      };
      return map[status] || 'bg-gray-100 text-gray-700';
    }

    function renderDashboard() {
      ensureHotelState();
      const rooms = getRoomsData();
      const reservations = getReservationsData();
      const occupied = reservations.filter(r => r.status === 'Checked-in').length;
      const occupancy = rooms.length ? Math.round((occupied / rooms.length) * 100) : 0;
      const revenue = reservations.reduce((sum, r) => sum + Number(r.totalPrice || 0), 0);
      const today = todayISO();
      const checkinsToday = reservations.filter(r => (r.checkinDate || '').startsWith(today)).length;
      const checkoutsToday = reservations.filter(r => (r.checkoutDate || '').startsWith(today)).length;

      document.getElementById('page-dashboard').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          ${card('áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒáƒ‘áƒ', `${occupancy}%`, 'ğŸ¨')}
          ${card('áƒ¡áƒ£áƒš áƒ¨áƒ”áƒ›áƒáƒ¡áƒáƒ•áƒáƒšáƒ˜', `${config.currency_symbol}${revenue.toLocaleString('en-US')}`, 'ğŸ’µ')}
          ${card('áƒ“áƒ¦áƒ”áƒ¡ Check-in', String(checkinsToday), 'ğŸ›¬')}
          ${card('áƒ“áƒ¦áƒ”áƒ¡ Check-out', String(checkoutsToday), 'ğŸ›«')}
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
          <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
            <h3 class="font-semibold mb-4">áƒ™áƒ•áƒ˜áƒ áƒ˜áƒ¡ áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒáƒ‘áƒ</h3>
            <div class="h-56 flex items-end gap-3">
              ${[70, 72, 79, 81, 88, 91, 84].map(v => `
                <div class="flex-1">
                  <div class="h-48 bg-sky-100 dark:bg-sky-900/20 rounded-t-lg relative overflow-hidden">
                    <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-sky-600 to-sky-400 rounded-t-lg" style="height:${v}%"></div>
                  </div>
                  <div class="text-xs text-center text-gray-500 mt-2">${v}%</div>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
            <h3 class="font-semibold mb-4">áƒ“áƒ¦áƒ˜áƒ¡ áƒáƒ¥áƒ¢áƒ˜áƒ•áƒáƒ‘áƒ</h3>
            <div class="space-y-3 text-sm">
              <div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">ğŸ”‘ Check-in - áƒœáƒáƒ›áƒ”áƒ áƒ˜ 102 (10:30)</div>
              <div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">ğŸ§¹ Housekeeping task áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ“áƒ (11:20)</div>
              <div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">ğŸ“ áƒáƒ®áƒáƒšáƒ˜ áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜: áƒáƒœáƒ áƒáƒ‘áƒáƒ¨áƒ˜áƒ«áƒ” (12:05)</div>
              <div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">ğŸ’³ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ ${config.currency_symbol}220 (13:10)</div>
            </div>
          </div>
        </div>
        <div class="mt-6 bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700 overflow-x-auto">
          <h3 class="font-semibold mb-4">áƒ£áƒáƒ®áƒšáƒ”áƒ¡áƒ˜ áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜</h3>
          <table class="w-full text-sm">
            <thead class="text-left text-gray-500"><tr><th class="pb-3">áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜</th><th class="pb-3">áƒœáƒáƒ›áƒ”áƒ áƒ˜</th><th class="pb-3">Check-in</th><th class="pb-3">Check-out</th><th class="pb-3">áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</th><th class="pb-3">áƒ—áƒáƒœáƒ®áƒ</th></tr></thead>
            <tbody>
              ${reservations.slice(0, 5).map(r => `
                <tr class="border-t border-gray-100 dark:border-gray-700">
                  <td class="py-3">${r.guestName || 'áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜'}</td>
                  <td class="py-3">${findRoomById(r.roomId)?.roomNumber || '-'}</td>
                  <td class="py-3">${formatDate(r.checkinDate)}</td>
                  <td class="py-3">${formatDate(r.checkoutDate)}</td>
                  <td class="py-3"><span class="px-2 py-1 rounded-full text-xs ${statusBadge(formatReservationStatus(r.status))}">${r.status || 'Reserved'}</span></td>
                  <td class="py-3 font-semibold">${config.currency_symbol}${Number(r.totalPrice || 0).toLocaleString('en-US')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderCalendar() {
      const rooms = getRoomsData();
      const reservations = getReservationsData();
      const date = calendarDate;
      const first = new Date(date.getFullYear(), date.getMonth(), 1);
      const last = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      const daysInMonth = last.getDate();
      const monthLabel = date.toLocaleDateString('ka-GE', { month: 'long', year: 'numeric' });
      const dayCells = Array.from({ length: daysInMonth }, (_, i) => i + 1);
      const weekendIndexes = new Set(dayCells.filter(d => {
        const wd = new Date(date.getFullYear(), date.getMonth(), d).getDay();
        return wd === 0 || wd === 6;
      }));
      const rows = rooms.map(room => {
        const cellRow = dayCells.map(d => `<div class="timeline-cell ${weekendIndexes.has(d) ? 'bg-amber-50/60 dark:bg-amber-900/10' : ''}"></div>`).join('');
        const rowReservations = reservations
          .filter(r => Number(r.roomId) === Number(room.id))
          .map(r => {
            const cin = parseISODateLocal(r.checkinDate);
            const cout = parseISODateLocal(r.checkoutDate);
            if (!cin || !cout) return null;
            const stayEnd = cout > cin ? addDays(cout, -1) : cin;
            const start = Math.max(1, cin.getMonth() === date.getMonth() ? cin.getDate() : 1);
            const end = Math.min(daysInMonth, stayEnd.getMonth() === date.getMonth() ? stayEnd.getDate() : daysInMonth);
            if (end < 1 || start > daysInMonth || end < start) return null;
            return { reservation: r, start, end };
          })
          .filter(Boolean)
          .sort((a, b) => a.start - b.start || a.end - b.end);

        // Assign each reservation to the first non-overlapping lane to avoid stacking collisions.
        const laneEnds = [];
        const bars = rowReservations.map(item => {
          let lane = 0;
          while (lane < laneEnds.length && item.start <= laneEnds[lane]) lane++;
          laneEnds[lane] = item.end;
          const top = 5 + lane * 34;
          const left = 160 + (item.start - 1) * 28 + 1;
          const width = Math.max(26, (item.end - item.start + 1) * 28);
          const r = item.reservation;
          const cls = r.status === 'Checked-in' ? 'checkedin' : r.status === 'Checked-out' ? 'checkout' : 'reserved';
          return `<div class="reservation-bar ${cls}" style="left:${left}px;top:${top}px;width:${width}px" onclick="openReservationDetails(${r.id})">${escapeHtml(r.guestName || '-')}</div>`;
        }).join('');
        const rowMinHeight = Math.max(42, laneEnds.length * 34 + 10);
        return `
          <div class="timeline-row" style="--days-in-month:${daysInMonth};min-height:${rowMinHeight}px">
            <div class="timeline-cell timeline-room">${room.roomName} <span class="text-[10px] text-gray-500 ml-2">${room.roomType}</span></div>
            ${cellRow}
            ${bars}
          </div>
        `;
      }).join('');
      document.getElementById('page-calendar').innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700 overflow-auto">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ™áƒáƒšáƒ”áƒœáƒ“áƒáƒ áƒ˜</h2>
            <div class="flex gap-2">
              <button onclick="calendarDate.setMonth(calendarDate.getMonth()-1);renderCalendar()" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">â†</button>
              <div class="px-3 py-2 font-semibold">${monthLabel}</div>
              <button onclick="calendarDate.setMonth(calendarDate.getMonth()+1);renderCalendar()" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">â†’</button>
              <button onclick="calendarDate=new Date();renderCalendar()" class="px-3 py-2 rounded-lg bg-sky-50 text-sky-700">áƒ“áƒ¦áƒ”áƒ¡</button>
            </div>
          </div>
          <div class="timeline-head bg-gray-100 dark:bg-gray-700/60 rounded-t-lg" style="--days-in-month:${daysInMonth}">
            <div class="timeline-cell timeline-room">áƒœáƒáƒ›áƒ”áƒ áƒ˜</div>
            ${dayCells.map(d => `<div class="timeline-cell ${weekendIndexes.has(d) ? 'bg-amber-100/70 dark:bg-amber-900/30' : ''}">${d}</div>`).join('')}
          </div>
          ${rows}
        </div>
      `;
    }

    function renderRooms() {
      const rooms = getRoomsData();
      document.getElementById('page-rooms').innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ</h2>
          <button onclick="openModal('new-room')" class="px-4 py-2 bg-sky-600 text-white rounded-xl">áƒáƒ®áƒáƒšáƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
          ${rooms.map(r => `
            <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-100 dark:border-gray-700">
              <div class="flex items-start justify-between">
                <div>
                  <div class="text-2xl font-bold">${r.roomNumber || '-'}</div>
                  <div class="text-sm text-gray-500">${r.roomType || 'Single'} â€¢ áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ˜ ${r.floor || 1}</div>
                </div>
                <span class="px-2 py-1 rounded-full text-xs ${r.status === 'available' ? 'bg-green-100 text-green-700' : r.status === 'occupied' ? 'bg-violet-100 text-violet-700' : r.status === 'booked' ? 'bg-sky-100 text-sky-700' : r.status === 'cleaning' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}">${r.status || 'available'}</span>
              </div>
              <div class="mt-4 text-sm text-gray-500">ğŸ›ï¸ ${r.beds || 1} áƒ¡áƒáƒ¬áƒáƒšáƒ˜ â€¢ ğŸ‘¥ áƒ›áƒáƒ¥áƒ¡. ${r.maxGuests || 2}</div>
              <div class="mt-2 font-semibold">${config.currency_symbol}${Number(r.basePrice || 0).toLocaleString('en-US')}/áƒ¦áƒáƒ›áƒ”</div>
              <button class="mt-3 px-3 py-2 text-xs rounded-lg bg-gray-100 dark:bg-gray-700" onclick="openRoomEdit(${r.id})">áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ</button>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderReservations() {
      const reservations = getReservationsData();
      document.getElementById('page-reservations').innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ</h2>
          <button onclick="openModal('new-reservation')" class="px-4 py-2 bg-sky-600 text-white rounded-xl">áƒáƒ®áƒáƒšáƒ˜ áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜</button>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 mb-6 border border-gray-100 dark:border-gray-700 flex flex-wrap gap-3">
          <input type="date" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">
          <input type="date" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">
          <select class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option>áƒ§áƒ•áƒ”áƒšáƒ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</option><option>pending</option><option>confirmed</option><option>checked-in</option><option>checked-out</option><option>cancelled</option></select>
          <button class="px-3 py-2 rounded-lg bg-sky-600 text-white">áƒ¤áƒ˜áƒšáƒ¢áƒ áƒ˜</button>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 dark:bg-gray-700/50">
              <tr>
                <th class="px-4 py-3 text-left">áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜</th>
                <th class="px-4 py-3 text-left">áƒœáƒáƒ›áƒ”áƒ áƒ˜</th>
                <th class="px-4 py-3 text-left">Check-in</th>
                <th class="px-4 py-3 text-left">Check-out</th>
                <th class="px-4 py-3 text-left">áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</th>
                <th class="px-4 py-3 text-left">áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ</th>
                <th class="px-4 py-3 text-left">áƒ—áƒáƒœáƒ®áƒ</th>
                <th class="px-4 py-3 text-left">áƒ“áƒáƒ™áƒ£áƒ›áƒ”áƒœáƒ¢áƒ”áƒ‘áƒ˜</th>
              </tr>
            </thead>
            <tbody>
              ${reservations.map(r => `
                <tr class="border-t border-gray-100 dark:border-gray-700">
                  <td class="px-4 py-3">${r.guestName || 'áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜'}</td>
                  <td class="px-4 py-3">${findRoomById(r.roomId)?.roomNumber || '-'}</td>
                  <td class="px-4 py-3">${formatDate(r.checkinDate)}</td>
                  <td class="px-4 py-3">${formatDate(r.checkoutDate)}</td>
                  <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs ${statusBadge(formatReservationStatus(r.status))}">${r.status || 'Reserved'}</span></td>
                  <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs ${paymentBadge(r.paymentStatus)}">${r.paymentStatus || 'unpaid'}</span></td>
                  <td class="px-4 py-3 font-semibold">${config.currency_symbol}${Number(r.totalPrice || 0).toLocaleString('en-US')}</td>
                  <td class="px-4 py-3">
                    <div class="flex gap-2 flex-wrap">
                      <button class="px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-xs" onclick="openReservationDetails(${r.id})">áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜</button>
                      <button class="px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-xs" onclick="printInvoice(${r.id})">áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜</button>
                      <button class="px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-xs" onclick="printConsent(${r.id}, 'ka')">áƒ—áƒáƒœáƒ®áƒ›áƒáƒ‘áƒ</button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderGuests() {
      const guests = getGuestsData();
      document.getElementById('page-guests').innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ</h2>
          <button onclick="openModal('new-guest')" class="px-4 py-2 bg-sky-600 text-white rounded-xl">áƒáƒ®áƒáƒšáƒ˜ áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
          ${guests.map(g => `
            <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-100 dark:border-gray-700">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-11 h-11 rounded-full bg-sky-600 text-white flex items-center justify-center font-bold">${(g.guestName || 'G').charAt(0).toUpperCase()}</div>
                <div>
                  <div class="font-semibold">${g.guestName || 'Guest'}</div>
                  <div class="text-xs text-gray-500">${g.guestEmail || '-'}</div>
                </div>
              </div>
              <div class="text-sm text-gray-500">${g.guestPhone || '-'}</div>
              ${g.flagged ? '<div class="mt-2 text-xs text-red-600">âš  áƒ›áƒáƒœáƒ˜áƒ¨áƒœáƒ£áƒšáƒ˜áƒ</div>' : ''}
              <button class="mt-3 px-3 py-2 text-xs rounded-lg bg-gray-100 dark:bg-gray-700" onclick="openGuestEdit('${escapeHtml(g.guestIdNumber || '')}')">áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ</button>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderCheckin() {
      const reservations = getReservationsData();
      const pendingIn = reservations.filter(r => r.status === 'Reserved');
      const pendingOut = reservations.filter(r => r.status === 'Checked-in');
      document.getElementById('page-checkin').innerHTML = `
        <h2 class="text-xl font-bold mb-6">Check-in / Check-out</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
            <h3 class="font-semibold mb-4">áƒ›áƒáƒšáƒáƒ“áƒ˜áƒœáƒ¨áƒ˜ Check-in</h3>
            <div class="space-y-3">${pendingIn.map(r => `
              <div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40 text-sm">
                <div>${r.guestName} â€¢ ${findRoomById(r.roomId)?.roomNumber || '-'} â€¢ ${formatDate(r.checkinDate)}</div>
                <div class="mt-2 flex gap-2">
                  <button class="px-2 py-1 rounded bg-white dark:bg-gray-800 text-xs" onclick="printConsent(${r.id}, 'ka')">áƒ—áƒáƒœáƒ®áƒ›áƒáƒ‘áƒ KA</button>
                  <button class="px-2 py-1 rounded bg-white dark:bg-gray-800 text-xs" onclick="printConsent(${r.id}, 'en')">Consent EN</button>
                </div>
              </div>`).join('') || '<div class="text-sm text-gray-500">áƒáƒ  áƒáƒ áƒ˜áƒ¡</div>'}</div>
          </div>
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
            <h3 class="font-semibold mb-4">áƒ›áƒáƒšáƒáƒ“áƒ˜áƒœáƒ¨áƒ˜ Check-out</h3>
            <div class="space-y-3">${pendingOut.map(r => `<div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40 text-sm">${r.guestName} â€¢ ${findRoomById(r.roomId)?.roomNumber || '-'} â€¢ ${formatDate(r.checkoutDate)}</div>`).join('') || '<div class="text-sm text-gray-500">áƒáƒ  áƒáƒ áƒ˜áƒ¡</div>'}</div>
          </div>
        </div>
      `;
    }

    function renderPayments() {
      ensureHotelState();
      const reservations = getReservationsData();
      const payments = getPaymentsData();
      const paid = reservations.filter(r => r.paymentStatus === 'paid').reduce((s, r) => s + Number(r.totalPrice || 0), 0);
      const unpaid = reservations.filter(r => r.paymentStatus !== 'paid').reduce((s, r) => s + Number(r.totalPrice || 0), 0);
      document.getElementById('page-payments').innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ”áƒ‘áƒ˜</h2>
          <button onclick="openModal('new-payment')" class="px-4 py-2 bg-sky-600 text-white rounded-xl">áƒáƒ®áƒáƒšáƒ˜ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-100 dark:border-gray-700"><p class="text-sm text-gray-500">áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜</p><p class="text-2xl font-bold">${config.currency_symbol}${paid.toLocaleString('en-US')}</p></div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-100 dark:border-gray-700"><p class="text-sm text-gray-500">áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒ“áƒ”áƒšáƒ˜</p><p class="text-2xl font-bold text-red-500">${config.currency_symbol}${unpaid.toLocaleString('en-US')}</p></div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-100 dark:border-gray-700"><p class="text-sm text-gray-500">Refund</p><p class="text-2xl font-bold text-amber-500">${config.currency_symbol}0</p></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 dark:bg-gray-700/50"><tr><th class="px-4 py-3 text-left">áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜</th><th class="px-4 py-3 text-left">áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜</th><th class="px-4 py-3 text-left">áƒ—áƒáƒœáƒ®áƒ</th><th class="px-4 py-3 text-left">áƒ›áƒ”áƒ—áƒáƒ“áƒ˜</th><th class="px-4 py-3 text-left">áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</th><th class="px-4 py-3 text-left">áƒ›áƒáƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ”áƒ‘áƒ˜</th></tr></thead>
            <tbody>${payments.map(p => `
              <tr class="border-t border-gray-100 dark:border-gray-700">
                <td class="px-4 py-3">${p.guestName}</td>
                <td class="px-4 py-3">#${p.reservationId}</td>
                <td class="px-4 py-3">${config.currency_symbol}${Number(p.amount || 0).toLocaleString('en-US')}</td>
                <td class="px-4 py-3">${p.method || '-'}</td>
                <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs ${paymentBadge(p.status)}">${p.status}</span></td>
                <td class="px-4 py-3"><div class="flex gap-2"><button class="px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-xs" onclick="openPaymentEdit(${p.id})">áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ</button><button class="px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-xs" onclick="printPaymentInvoice(${p.id})">áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜</button></div></td>
              </tr>
            `).join('') || '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-500">áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡</td></tr>'}</tbody>
          </table>
        </div>
      `;
    }

    function renderHousekeeping() {
      const rooms = getRoomsData();
      const clean = rooms.filter(r => r.status === 'available').length;
      const dirty = rooms.filter(r => r.status === 'cleaning').length || 3;
      const maintenance = rooms.filter(r => r.status === 'maintenance').length;
      document.getElementById('page-housekeeping').innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Housekeeping</h2>
          <button onclick="showToast('áƒ“áƒáƒ•áƒáƒšáƒ”áƒ‘áƒ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ')" class="px-4 py-2 bg-sky-600 text-white rounded-xl">áƒáƒ®áƒáƒšáƒ˜ áƒ“áƒáƒ•áƒáƒšáƒ”áƒ‘áƒ</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl p-4"><p class="text-sm text-green-700">áƒ¡áƒ£áƒ¤áƒ—áƒ</p><p class="text-2xl font-bold">${clean}</p></div>
          <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4"><p class="text-sm text-amber-700">áƒ“áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ</p><p class="text-2xl font-bold">${dirty}</p></div>
          <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4"><p class="text-sm text-red-700">áƒ áƒ”áƒ›áƒáƒœáƒ¢áƒ˜</p><p class="text-2xl font-bold">${maintenance}</p></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700"><h3 class="font-semibold mb-4">To Do</h3><div class="space-y-2 text-sm"><div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">101 - Linen áƒ¨áƒ”áƒªáƒ•áƒšáƒ</div><div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">202 - Deep clean</div></div></div>
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700"><h3 class="font-semibold mb-4">In Progress</h3><div class="space-y-2 text-sm"><div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">301 - Bathroom repair</div></div></div>
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700"><h3 class="font-semibold mb-4">Done</h3><div class="space-y-2 text-sm"><div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">102 - áƒ›áƒ–áƒáƒ“áƒáƒ</div></div></div>
        </div>
      `;
    }

    function renderPricing() {
      document.getElementById('page-pricing').innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ¢áƒáƒ áƒ˜áƒ¤áƒ”áƒ‘áƒ˜</h2>
          <button onclick="showToast('áƒ¢áƒáƒ áƒ˜áƒ¤áƒ˜ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ')" class="px-4 py-2 bg-sky-600 text-white rounded-xl">áƒáƒ®áƒáƒšáƒ˜ áƒ¢áƒáƒ áƒ˜áƒ¤áƒ˜</button>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <div class="lg:col-span-3 bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700 overflow-x-auto">
            <h3 class="font-semibold mb-4">áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜ áƒ—áƒ•áƒ”áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ®áƒ”áƒ“áƒ•áƒ˜áƒ— (áƒ”áƒ“áƒ˜áƒ¢áƒ˜áƒœáƒ’áƒ˜)</h3>
            <table class="w-full text-sm">
              <thead><tr class="text-left text-gray-500"><th class="py-2">áƒ—áƒ•áƒ”</th>${getRoomTypes().map(t => `<th class="py-2">${t}</th>`).join('')}</tr></thead>
              <tbody>
                ${Array.from({ length: 12 }, (_, i) => i + 1).map(m => {
                  const row = getMonthlyRates()[m] || {};
                  return `<tr class="border-t border-gray-100 dark:border-gray-700"><td class="py-2">áƒ—áƒ•áƒ” ${m}</td>${getRoomTypes().map(t => `<td class="py-2"><input type="number" min="0" id="rate_${m}_${t}" value="${Number(row[t] || 0)}" class="w-24 px-2 py-1 rounded bg-gray-100 dark:bg-gray-700"></td>`).join('')}</tr>`;
                }).join('')}
              </tbody>
            </table>
            <button onclick="saveMonthlyRates()" class="mt-4 px-4 py-2 bg-sky-600 text-white rounded-xl">áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
          </div>
        </div>
      `;
    }

    function renderReports() {
      document.getElementById('page-reports').innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">áƒ áƒ”áƒáƒáƒ áƒ¢áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒáƒœáƒáƒšáƒ˜áƒ¢áƒ˜áƒ™áƒ</h2>
          <div class="flex gap-2"><select class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option>áƒ‘áƒáƒšáƒ áƒ—áƒ•áƒ”</option><option>áƒ‘áƒáƒšáƒ áƒ™áƒ•áƒáƒ áƒ¢áƒáƒšáƒ˜</option></select><button class="px-3 py-2 rounded-lg bg-sky-600 text-white">PDF</button></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-100 dark:border-gray-700"><p class="text-sm text-gray-500">áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒáƒ‘áƒ</p><p class="text-2xl font-bold">72.4%</p></div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-100 dark:border-gray-700"><p class="text-sm text-gray-500">ADR</p><p class="text-2xl font-bold">${config.currency_symbol}185</p></div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-100 dark:border-gray-700"><p class="text-sm text-gray-500">RevPAR</p><p class="text-2xl font-bold">${config.currency_symbol}134</p></div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border border-gray-100 dark:border-gray-700"><p class="text-sm text-gray-500">No-show</p><p class="text-2xl font-bold">4.2%</p></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700"><h3 class="font-semibold mb-4">áƒ¨áƒ”áƒ›áƒáƒ¡áƒáƒ•áƒáƒšáƒ˜ áƒ—áƒ•áƒ”áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ®áƒ”áƒ“áƒ•áƒ˜áƒ—</h3><div class="h-52 flex items-end gap-2">${[60, 72, 80, 76, 84, 92, 95, 88, 79, 82, 90, 97].map(v => `<div class="flex-1 bg-sky-100 dark:bg-sky-900/20 rounded-t relative"><div class="absolute bottom-0 inset-x-0 bg-sky-500 rounded-t" style="height:${v}%"></div></div>`).join('')}</div></div>
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700"><h3 class="font-semibold mb-4">áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¬áƒ§áƒáƒ áƒ</h3><div class="space-y-3 text-sm"><div class="flex justify-between"><span>Booking.com</span><span>45%</span></div><div class="flex justify-between"><span>Airbnb</span><span>22%</span></div><div class="flex justify-between"><span>Direct</span><span>18%</span></div><div class="flex justify-between"><span>Expedia</span><span>15%</span></div></div></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
          <h3 class="font-semibold mb-4">áƒœáƒáƒ›áƒ áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm"><thead><tr class="text-left text-gray-500"><th class="pb-2">áƒ¢áƒ˜áƒáƒ˜</th><th class="pb-2">áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒáƒ‘áƒ</th><th class="pb-2">ADR</th><th class="pb-2">áƒ¨áƒ”áƒ›áƒáƒ¡áƒáƒ•áƒáƒšáƒ˜</th></tr></thead><tbody><tr class="border-t border-gray-100 dark:border-gray-700"><td class="py-3">Standard</td><td class="py-3">78%</td><td class="py-3">${config.currency_symbol}125</td><td class="py-3">${config.currency_symbol}42,500</td></tr><tr class="border-t border-gray-100 dark:border-gray-700"><td class="py-3">Deluxe</td><td class="py-3">68%</td><td class="py-3">${config.currency_symbol}210</td><td class="py-3">${config.currency_symbol}38,220</td></tr><tr class="border-t border-gray-100 dark:border-gray-700"><td class="py-3">Suite</td><td class="py-3">52%</td><td class="py-3">${config.currency_symbol}450</td><td class="py-3">${config.currency_symbol}46,800</td></tr></tbody></table>
          </div>
        </div>
      `;
    }

    function renderSettings() {
      document.getElementById('page-settings').innerHTML = `
        <h2 class="text-xl font-bold mb-6">áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-6">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
              <h3 class="font-semibold mb-4">áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒáƒ¡ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input id="settingsHotelName" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(config.hotel_name || defaultConfig.hotel_name)}" placeholder="áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒáƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜">
                <input id="settingsHotelEmail" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(config.hotel_email || defaultConfig.hotel_email)}" placeholder="áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒ">
                <input id="settingsHotelPhone" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(config.hotel_phone || defaultConfig.hotel_phone)}" placeholder="áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜">
                <input id="settingsHotelAddress" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(config.hotel_address || defaultConfig.hotel_address)}" placeholder="áƒ›áƒ˜áƒ¡áƒáƒ›áƒáƒ áƒ—áƒ˜">
              </div>
              <button class="mt-4 px-4 py-2 rounded-lg bg-sky-600 text-white" onclick="saveHotelSettings()">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
              <h3 class="font-semibold mb-4">áƒáƒáƒšáƒ˜áƒ¢áƒ˜áƒ™áƒ</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                  <label class="block mb-1 text-gray-500">Check-in áƒ“áƒ áƒ (áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ˜áƒ¡ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒœáƒ“áƒáƒ áƒ¢áƒ£áƒšáƒ˜ áƒ“áƒ áƒ)</label>
                  <input type="time" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="14:00">
                </div>
                <div>
                  <label class="block mb-1 text-gray-500">Check-out áƒ“áƒ áƒ (áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ˜áƒ¡ áƒ’áƒáƒ¡áƒ•áƒšáƒ˜áƒ¡ áƒ‘áƒáƒšáƒ áƒ“áƒ áƒ)</label>
                  <input type="time" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="12:00">
                </div>
                <div>
                  <label class="block mb-1 text-gray-500">áƒ£áƒ¤áƒáƒ¡áƒ áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ•áƒáƒ“áƒ (áƒ¡áƒáƒáƒ—áƒ˜)</label>
                  <input type="number" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="24">
                </div>
                <div>
                  <label class="block mb-1 text-gray-500">áƒ¡áƒáƒ•áƒáƒšáƒ“áƒ”áƒ‘áƒ£áƒšáƒ áƒáƒ•áƒáƒœáƒ¡áƒ˜ (%)</label>
                  <input type="number" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="30">
                </div>
                <div>
                  <label class="block mb-1 text-gray-500">áƒ’áƒ•áƒ˜áƒáƒœáƒ˜ Check-out (áƒ¡áƒáƒáƒ—áƒ˜/áƒ¢áƒáƒ áƒ˜áƒ¤áƒ˜)</label>
                  <input class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="12:00 áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’ â€¢ 10â‚¾ / áƒ¡áƒáƒáƒ—áƒ˜">
                </div>
                <div>
                  <label class="block mb-1 text-gray-500">No-show áƒ¯áƒáƒ áƒ˜áƒ›áƒ (áƒ¦áƒáƒ›áƒ”áƒ”áƒ‘áƒ˜áƒ¡ áƒ áƒáƒáƒ“áƒ”áƒœáƒáƒ‘áƒ)</label>
                  <input type="number" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="1">
                </div>
              </div>
              <button class="mt-4 px-4 py-2 rounded-lg bg-sky-600 text-white" onclick="showToast('áƒáƒáƒšáƒ˜áƒ¢áƒ˜áƒ™áƒ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ')">áƒáƒáƒšáƒ˜áƒ¢áƒ˜áƒ™áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
            </div>
          </div>
          <div class="space-y-6">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
              <h3 class="font-semibold mb-4">áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜</h3>
              <div class="space-y-3 text-sm">
                <div class="flex justify-between"><span>áƒ”áƒš. áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ”áƒ‘áƒ˜</span><span class="text-green-600">áƒ©áƒáƒ áƒ—áƒ£áƒšáƒ˜</span></div>
                <div class="flex justify-between"><span>SMS áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ”áƒ‘áƒ˜</span><span class="text-gray-500">áƒ’áƒáƒ›áƒáƒ áƒ—áƒ£áƒšáƒ˜</span></div>
                <div class="flex justify-between"><span>áƒáƒ•áƒ¢áƒ-áƒ¡áƒ˜áƒœáƒ¥áƒ˜</span><span class="text-green-600">áƒ©áƒáƒ áƒ—áƒ£áƒšáƒ˜</span></div>
              </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
              <h3 class="font-semibold mb-4">Audit Log</h3>
              <div class="space-y-2 text-xs text-gray-500">
                <div>áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜ #1234 áƒ¨áƒ”áƒ˜áƒ¥áƒ›áƒœáƒ â€¢ 5 áƒ¬áƒ— áƒ¬áƒ˜áƒœ</div>
                <div>Check-in áƒœáƒáƒ›áƒ”áƒ áƒ˜ 102 â€¢ 17 áƒ¬áƒ— áƒ¬áƒ˜áƒœ</div>
                <div>áƒ¤áƒáƒ¡áƒ˜ áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ (Suite) â€¢ 1 áƒ¡áƒ— áƒ¬áƒ˜áƒœ</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function saveHotelSettings() {
      config = {
        ...config,
        hotel_name: document.getElementById('settingsHotelName')?.value.trim() || defaultConfig.hotel_name,
        hotel_email: document.getElementById('settingsHotelEmail')?.value.trim() || defaultConfig.hotel_email,
        hotel_phone: document.getElementById('settingsHotelPhone')?.value.trim() || defaultConfig.hotel_phone,
        hotel_address: document.getElementById('settingsHotelAddress')?.value.trim() || defaultConfig.hotel_address
      };
      setState('hotelConfig', config);
      if (window.elementSdk?.setConfig) window.elementSdk.setConfig(config);
      applyConfig();
      showToast('áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ');
    }

    function saveMonthlyRates() {
      const rates = {};
      for (let m = 1; m <= 12; m++) {
        rates[m] = {};
        getRoomTypes().forEach(t => {
          rates[m][t] = Number(document.getElementById(`rate_${m}_${t}`)?.value || 0);
        });
      }
      setState('monthlyRates', rates);
      showToast('áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ');
    }

    function autoFillGuestById() {
      const id = document.getElementById('newGuestIdNumber')?.value.trim();
      if (!id) return;
      const guest = getGuestsData().find(g => g.guestIdNumber === id);
      if (!guest) return;
      document.getElementById('newGuestName').value = guest.guestName || '';
      document.getElementById('newGuestPhone').value = guest.guestPhone || '';
      document.getElementById('newGuestEmail').value = guest.guestEmail || '';
      document.getElementById('newGuestCitizenship').value = guest.guestCitizenship || '';
      document.getElementById('newGuestBirthDate').value = guest.guestBirthDate || '';
    }

    function addNewReservation() {
      const guestName = document.getElementById('newGuestName').value.trim();
      const guestPhone = document.getElementById('newGuestPhone').value.trim();
      const guestEmail = document.getElementById('newGuestEmail').value.trim();
      const guestIdNumber = document.getElementById('newGuestIdNumber').value.trim();
      const guestCitizenship = document.getElementById('newGuestCitizenship').value.trim();
      const guestBirthDate = document.getElementById('newGuestBirthDate').value;
      const roomId = Number(document.getElementById('newRoomId').value);
      const checkinDate = document.getElementById('newCheckinDate').value;
      const checkoutDate = document.getElementById('newCheckoutDate').value;
      const paymentStatus = document.getElementById('newPaymentStatus').value;
      if (!guestName || !checkinDate || !checkoutDate) return showToast('áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”áƒ— áƒáƒ£áƒªáƒ˜áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ•áƒ”áƒšáƒ”áƒ‘áƒ˜', 'error');
      const room = findRoomById(roomId);
      const nights = calculateNights(checkinDate, checkoutDate);
      const totalPrice = nights * Number(room?.basePrice || 0);
      const nextId = Number(getState('nextReservationId', 1));
      const reservations = getReservationsData();
      reservations.push({ id: nextId, guestName, guestPhone, guestEmail, guestIdNumber, guestCitizenship, guestBirthDate, roomId, checkinDate, checkoutDate, status: 'Reserved', paymentStatus, totalPrice });
      setReservationsData(reservations);
      setState('nextReservationId', nextId + 1);
      if (guestIdNumber) {
        const guests = getGuestsData();
        const idx = guests.findIndex(g => g.guestIdNumber === guestIdNumber);
        const guestPayload = { guestName, guestPhone, guestEmail, guestIdNumber, guestCitizenship, guestBirthDate };
        if (idx === -1) guests.push(guestPayload); else guests[idx] = { ...guests[idx], ...guestPayload };
        setGuestsData(guests);
      }
      closeModal();
      showToast('áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ— áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ');
      renderCurrentPage();
    }

    function openReservationDetails(resId) {
      const res = getReservationsData().find(r => Number(r.id) === Number(resId));
      if (!res) return;
      const room = findRoomById(res.roomId);
      openModal('custom');
      document.getElementById('modal-title').textContent = 'áƒ¯áƒáƒ•áƒ¨áƒœáƒ˜áƒ¡ áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜';
      document.getElementById('modal-content').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <input id="editGuestName" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(res.guestName || '')}" placeholder="áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜">
          <input id="editGuestPhone" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(res.guestPhone || '')}" placeholder="áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜">
          <input id="editGuestEmail" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(res.guestEmail || '')}" placeholder="áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒ">
          <input id="editGuestIdNumber" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(res.guestIdNumber || '')}" placeholder="áƒáƒ˜áƒ áƒáƒ“áƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜ / áƒáƒáƒ¡áƒáƒáƒ áƒ¢áƒ˜">
          <input id="editGuestCitizenship" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(res.guestCitizenship || '')}" placeholder="áƒ›áƒáƒ¥áƒáƒšáƒáƒ¥áƒ”áƒáƒ‘áƒ">
          <input id="editGuestBirthDate" type="date" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(res.guestBirthDate || '')}">
          <select id="editRoomId" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">${getRoomsData().map(r => `<option value="${r.id}" ${Number(r.id)===Number(res.roomId)?'selected':''}>${r.roomName} (${r.roomType})</option>`).join('')}</select>
          <select id="editStatus" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option ${res.status==='Reserved'?'selected':''}>Reserved</option><option ${res.status==='Checked-in'?'selected':''}>Checked-in</option><option ${res.status==='Checked-out'?'selected':''}>Checked-out</option><option ${res.status==='Cancelled'?'selected':''}>Cancelled</option></select>
          <input id="editCheckinDate" type="date" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(res.checkinDate || '')}">
          <input id="editCheckoutDate" type="date" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(res.checkoutDate || '')}">
          <select id="editPaymentStatus" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option value="unpaid" ${res.paymentStatus==='unpaid'?'selected':''}>unpaid</option><option value="partial" ${res.paymentStatus==='partial'?'selected':''}>partial</option><option value="paid" ${res.paymentStatus==='paid'?'selected':''}>paid</option></select>
          <input id="editTotalPrice" type="number" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${Number(res.totalPrice||0)}">
          <select id="editConsentLang" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option value="ka">áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜</option><option value="en">English</option></select>
        </div>
        <div class="flex gap-2 mt-4 flex-wrap">
          <button class="px-3 py-2 rounded bg-sky-600 text-white" onclick="saveReservationEdits(${res.id})">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
          <button class="px-3 py-2 rounded bg-emerald-600 text-white" onclick="checkInReservation(${res.id})">Check-in</button>
          <button class="px-3 py-2 rounded bg-amber-500 text-white" onclick="checkOutReservation(${res.id})">Check-out</button>
          <button class="px-3 py-2 rounded bg-red-600 text-white" onclick="deleteReservation(${res.id})">áƒ¬áƒáƒ¨áƒšáƒ</button>
          <button class="px-3 py-2 rounded bg-gray-100 dark:bg-gray-700" onclick="printConsent(${res.id}, 'ka')">áƒ—áƒáƒœáƒ®áƒ›áƒáƒ‘áƒ KA</button>
          <button class="px-3 py-2 rounded bg-gray-100 dark:bg-gray-700" onclick="printConsent(${res.id}, 'en')">Consent EN</button>
        </div>
        <div class="mt-3 text-xs text-gray-500">áƒáƒ—áƒáƒ®áƒ˜: ${escapeHtml(room?.roomName || room?.roomNumber || '-')} (${escapeHtml(room?.roomType || '-')})</div>
      `;
    }

    function saveReservationEdits(resId) {
      const reservations = getReservationsData();
      const idx = reservations.findIndex(r => Number(r.id) === Number(resId));
      if (idx === -1) return;
      reservations[idx] = {
        ...reservations[idx],
        guestName: document.getElementById('editGuestName').value.trim(),
        guestPhone: document.getElementById('editGuestPhone').value.trim(),
        guestEmail: document.getElementById('editGuestEmail').value.trim(),
        guestIdNumber: document.getElementById('editGuestIdNumber').value.trim(),
        guestCitizenship: document.getElementById('editGuestCitizenship').value.trim(),
        guestBirthDate: document.getElementById('editGuestBirthDate').value,
        roomId: Number(document.getElementById('editRoomId').value),
        status: document.getElementById('editStatus').value,
        checkinDate: document.getElementById('editCheckinDate').value,
        checkoutDate: document.getElementById('editCheckoutDate').value,
        paymentStatus: document.getElementById('editPaymentStatus').value,
        totalPrice: Number(document.getElementById('editTotalPrice').value || 0)
      };
      setReservationsData(reservations);
      showToast('áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜ áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ');
      closeModal();
      renderCurrentPage();
    }

    function deleteReservation(resId) {
      if (!confirm('áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ’áƒ¡áƒ£áƒ áƒ— áƒ¯áƒáƒ•áƒ¨áƒœáƒ˜áƒ¡ áƒ¬áƒáƒ¨áƒšáƒ?')) return;
      const reservations = getReservationsData().filter(r => Number(r.id) !== Number(resId));
      setReservationsData(reservations);
      showToast('áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜ áƒ¬áƒáƒ˜áƒ¨áƒáƒšáƒ', 'warning');
      closeModal();
      renderCurrentPage();
    }

    function checkInReservation(resId) {
      const reservations = getReservationsData();
      const idx = reservations.findIndex(r => Number(r.id) === Number(resId));
      if (idx === -1) return;
      reservations[idx].status = 'Checked-in';
      setReservationsData(reservations);
      const room = findRoomById(reservations[idx].roomId);
      if (room) {
        const rooms = getRoomsData();
        const rIdx = rooms.findIndex(r => Number(r.id) === Number(room.id));
        if (rIdx !== -1) {
          rooms[rIdx].status = 'occupied';
          setRoomsData(rooms);
        }
      }
      showToast('Check-in áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ“áƒ');
      closeModal();
      renderCurrentPage();
    }

    function checkOutReservation(resId) {
      const reservations = getReservationsData();
      const idx = reservations.findIndex(r => Number(r.id) === Number(resId));
      if (idx === -1) return;
      reservations[idx].status = 'Checked-out';
      setReservationsData(reservations);
      const room = findRoomById(reservations[idx].roomId);
      if (room) {
        const rooms = getRoomsData();
        const rIdx = rooms.findIndex(r => Number(r.id) === Number(room.id));
        if (rIdx !== -1) {
          rooms[rIdx].status = 'available';
          setRoomsData(rooms);
        }
      }
      showToast('Check-out áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ“áƒ');
      closeModal();
      renderCurrentPage();
    }

    function getReservationFinancials(resId) {
      const res = getReservationsData().find(r => Number(r.id) === Number(resId));
      if (!res) return { nights: 0, baseTotal: 0, lateCheckoutFee: 0, grossTotal: 0, advance: 0, dueTotal: 0 };
      const room = findRoomById(res.roomId);
      const nights = calculateNights(res.checkinDate, res.checkoutDate);
      const baseTotal = nights * Number(room?.basePrice || 0);
      const grossTotal = Number(res.totalPrice || baseTotal);
      const advance = 0;
      const dueTotal = Math.max(0, grossTotal - advance);
      return { nights, baseTotal, lateCheckoutFee: 0, grossTotal, advance, dueTotal };
    }

    function printInvoice(resId) {
      const res = getReservationsData().find(r => Number(r.id) === Number(resId));
      if (!res) return;
      const room = findRoomById(res.roomId);
      const financials = getReservationFinancials(resId);
      const invoiceNo = `INV-${res.id}-${new Date().getTime()}`;
      const hotel = getHotelIdentity();
      const w = window.open('', '_blank');
      if (!w) return;
      w.document.write(`
        <!DOCTYPE html>
        <html lang="ka">
        <head>
          <meta charset="UTF-8">
          <title>áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜ ${invoiceNo}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 32px; color: #0f172a; }
            h1 { margin: 0 0 8px; }
            .muted { color: #64748b; }
            .row { display: flex; justify-content: space-between; gap: 16px; }
            .box { border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-top: 16px; }
            table { width: 100%; border-collapse: collapse; margin-top: 12px; }
            th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
            th { background: #f1f5f9; }
            .total { font-size: 18px; font-weight: 700; }
            .right { text-align: right; }
            @media print { .no-print { display: none; } }
          </style>
        </head>
        <body>
          <div class="row">
            <div>
              <h1>${escapeHtml(hotel.name)} â€” áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜</h1>
              <div class="muted">áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ˜áƒ¡ â„–: ${invoiceNo}</div>
              <div class="muted">áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜: ${formatDate(new Date())}</div>
              <div class="muted">${escapeHtml(hotel.phone)} â€¢ ${escapeHtml(hotel.email)}</div>
              <div class="muted">${escapeHtml(hotel.address)}</div>
            </div>
            <div class="right"><div class="muted">áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜: ${res.status}</div></div>
          </div>
          <div class="box">
            <div><strong>áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜:</strong> ${escapeHtml(res.guestName)}</div>
            <div><strong>áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜:</strong> ${escapeHtml(res.guestPhone || '-')}</div>
            <div><strong>áƒáƒ—áƒáƒ®áƒ˜:</strong> ${escapeHtml(room ? (room.roomName || room.roomNumber) : '-')} (${escapeHtml(room?.roomType || '-')})</div>
            <div><strong>áƒ—áƒáƒ áƒ˜áƒ¦áƒ”áƒ‘áƒ˜:</strong> ${formatDate(res.checkinDate)} â€” ${formatDate(res.checkoutDate)}</div>
          </div>
          <div class="box">
            <table>
              <thead><tr><th>áƒáƒ¦áƒ¬áƒ”áƒ áƒ</th><th class="right">áƒ áƒáƒáƒ“áƒ”áƒœáƒáƒ‘áƒ</th><th class="right">áƒ¤áƒáƒ¡áƒ˜</th><th class="right">áƒ¯áƒáƒ›áƒ˜</th></tr></thead>
              <tbody>
                <tr><td>áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒ â€” áƒ¦áƒáƒ›áƒ”áƒ”áƒ‘áƒ˜</td><td class="right">${financials.nights}</td><td class="right">${Number(room?.basePrice || 0)}â‚¾</td><td class="right">${financials.baseTotal}â‚¾</td></tr>
                <tr><td>áƒáƒ•áƒáƒœáƒ¡áƒ˜</td><td class="right">1</td><td class="right">-</td><td class="right">-${financials.advance}â‚¾</td></tr>
              </tbody>
            </table>
            <div class="row" style="margin-top: 12px;"><div></div><div class="total">áƒ¡áƒ áƒ£áƒšáƒ˜: ${financials.grossTotal}â‚¾ | áƒáƒ•áƒáƒœáƒ¡áƒ˜: ${financials.advance}â‚¾ | áƒ“áƒáƒ¡áƒáƒ áƒ©áƒ”áƒœáƒ˜: ${financials.dueTotal}â‚¾</div></div>
          </div>
          <div class="no-print" style="margin-top: 16px;"><button onclick="window.print()">áƒ‘áƒ”áƒ­áƒ“áƒ•áƒ</button></div>
        </body>
        </html>
      `);
      w.document.close();
      w.focus();
      setTimeout(() => w.print(), 120);
    }

    function printConsent(resId, lang = 'ka') {
      const res = getReservationsData().find(r => Number(r.id) === Number(resId));
      if (!res) return;
      const room = findRoomById(res.roomId);
      const hotel = getHotelIdentity();
      const w = window.open('', '_blank');
      if (!w) return;
      const isKa = lang === 'ka';
      const title = isKa ? 'áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ˜áƒ¡ áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ˜áƒ¡áƒ áƒ“áƒ áƒ—áƒáƒœáƒ®áƒ›áƒáƒ‘áƒ˜áƒ¡ áƒ¤áƒáƒ áƒ›áƒ' : 'Guest Registration and Consent Form';
      const consentText = isKa ? `
        <p><strong>áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒáƒ¡ áƒ“áƒáƒ¡áƒáƒ®áƒ”áƒšáƒ”áƒ‘áƒ:</strong> ${escapeHtml(hotel.name)}</p>
        <p><strong>áƒ›áƒ˜áƒ¡áƒáƒ›áƒáƒ áƒ—áƒ˜:</strong> ${escapeHtml(hotel.address)}</p>
        <p><strong>áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜ / áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒ:</strong> ${escapeHtml(hotel.phone)} / ${escapeHtml(hotel.email)}</p>
        <h4>áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ˜áƒ¡ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ</h4>
        <p><strong>áƒ¡áƒáƒ®áƒ”áƒšáƒ˜, áƒ’áƒ•áƒáƒ áƒ˜:</strong> ${escapeHtml(res.guestName || '')}</p>
        <p><strong>áƒáƒ˜áƒ áƒáƒ“áƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜ / áƒáƒáƒ¡áƒáƒáƒ áƒ¢áƒ˜áƒ¡ â„–:</strong> ${escapeHtml(res.guestIdNumber || '')}</p>
        <p><strong>áƒ›áƒáƒ¥áƒáƒšáƒáƒ¥áƒ”áƒáƒ‘áƒ:</strong> ${escapeHtml(res.guestCitizenship || '')}</p>
        <p><strong>áƒ“áƒáƒ‘áƒáƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜:</strong> ${escapeHtml(res.guestBirthDate || '')}</p>
        <p><strong>áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜áƒ¡ áƒœáƒáƒ›áƒ”áƒ áƒ˜:</strong> ${escapeHtml(res.guestPhone || '')}</p>
        <p><strong>áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒ (áƒáƒ áƒáƒ¡áƒáƒ•áƒáƒšáƒ“áƒ”áƒ‘áƒ£áƒšáƒ):</strong> ${escapeHtml(res.guestEmail || '')}</p>
        <h4>áƒ’áƒáƒœáƒ—áƒáƒ•áƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜</h4>
        <p><strong>áƒ©áƒ”áƒ¥áƒ˜áƒœáƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜:</strong> ${formatDate(res.checkinDate)}</p>
        <p><strong>áƒ©áƒ”áƒ¥áƒáƒ£áƒ—áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜:</strong> ${formatDate(res.checkoutDate)}</p>
        <p><strong>áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒœáƒáƒ›áƒ”áƒ áƒ˜ / áƒ¢áƒ˜áƒáƒ˜:</strong> ${escapeHtml(room ? (room.roomName || room.roomNumber) : '-')} / ${escapeHtml(room?.roomType || '-')}</p>
        <h4>áƒ—áƒáƒœáƒ®áƒ›áƒáƒ‘áƒ áƒ“áƒ áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ</h4>
        <p>áƒ›áƒ˜áƒ•áƒ˜áƒ¦áƒ” áƒ“áƒ áƒ’áƒáƒ•áƒ”áƒªáƒáƒœáƒ˜ áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒáƒ¡ áƒ¨áƒ˜áƒ“áƒ áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ¡ áƒ“áƒ áƒ•áƒ”áƒ—áƒáƒœáƒ®áƒ›áƒ”áƒ‘áƒ˜ áƒ›áƒáƒ— áƒ“áƒáƒªáƒ•áƒáƒ¡;</p>
        <p>áƒ•áƒ˜áƒ¦áƒ”áƒ‘ áƒáƒáƒ¡áƒ£áƒ®áƒ˜áƒ¡áƒ›áƒ’áƒ”áƒ‘áƒšáƒáƒ‘áƒáƒ¡ áƒœáƒáƒ›áƒ”áƒ áƒ¨áƒ˜ áƒáƒ áƒ¡áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ˜áƒœáƒ•áƒ”áƒœáƒ¢áƒáƒ áƒ˜áƒ¡ áƒ“áƒáƒ–áƒ˜áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒáƒœ áƒ“áƒáƒ™áƒáƒ áƒ’áƒ•áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ—áƒ®áƒ•áƒ”áƒ•áƒáƒ¨áƒ˜;</p>
        <p>áƒ•áƒ”áƒ—áƒáƒœáƒ®áƒ›áƒ”áƒ‘áƒ˜, áƒ áƒáƒ› áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒ áƒ£áƒ¤áƒšáƒ”áƒ‘áƒáƒ›áƒáƒ¡áƒ˜áƒšáƒ˜áƒ áƒ“áƒáƒáƒ›áƒ£áƒ¨áƒáƒáƒ¡ áƒ©áƒ”áƒ›áƒ˜ áƒáƒ”áƒ áƒ¡áƒáƒœáƒáƒšáƒ£áƒ áƒ˜ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜ áƒ›áƒ®áƒáƒšáƒáƒ“ áƒ›áƒáƒ›áƒ¡áƒáƒ®áƒ£áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ¬áƒ”áƒ•áƒ˜áƒ¡ áƒ›áƒ˜áƒ–áƒœáƒ˜áƒ—;</p>
        <p>áƒ•áƒáƒªáƒœáƒáƒ‘áƒ˜áƒ”áƒ áƒ”áƒ‘, áƒ áƒáƒ› áƒ©áƒ”áƒ¥áƒáƒ£áƒ—áƒ˜áƒ¡ áƒ“áƒáƒ’áƒ•áƒ˜áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒáƒœ áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒáƒ áƒ¦áƒ•áƒ”áƒ•áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ—áƒ®áƒ•áƒ”áƒ•áƒáƒ¨áƒ˜ áƒ¨áƒ”áƒ¡áƒáƒ«áƒšáƒáƒ áƒ“áƒáƒ›áƒ”áƒ™áƒ˜áƒ¡áƒ áƒáƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ—áƒ˜ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜.</p>
        <p>â˜ áƒ•áƒ”áƒ—áƒáƒœáƒ®áƒ›áƒ”áƒ‘áƒ˜ áƒ–áƒ”áƒ›áƒáƒ— áƒ©áƒáƒ›áƒáƒ—áƒ•áƒšáƒ˜áƒš áƒáƒ˜áƒ áƒáƒ‘áƒ”áƒ‘áƒ¡</p>
        <h4>áƒ®áƒ”áƒšáƒ›áƒáƒ¬áƒ”áƒ áƒ</h4>
        <p><strong>áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ˜áƒ¡ áƒ®áƒ”áƒšáƒ›áƒáƒ¬áƒ”áƒ áƒ:</strong> _________________________________</p>
        <p><strong>áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜:</strong> _____________________</p>
        <p><strong>áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒáƒ¡ áƒ¬áƒáƒ áƒ›áƒáƒ›áƒáƒ“áƒ’áƒ”áƒœáƒšáƒ˜áƒ¡ áƒ®áƒ”áƒšáƒ›áƒáƒ¬áƒ”áƒ áƒ:</strong> __________________.</p>
      ` : `
        <p><strong>Hotel Name:</strong> ${escapeHtml(hotel.name)}</p>
        <p><strong>Address:</strong> ${escapeHtml(hotel.address)}</p>
        <p><strong>Phone / Email:</strong> ${escapeHtml(hotel.phone)} / ${escapeHtml(hotel.email)}</p>
        <h4>Guest Information</h4>
        <p><strong>Full Name:</strong> ${escapeHtml(res.guestName || '')}</p>
        <p><strong>ID / Passport No.:</strong> ${escapeHtml(res.guestIdNumber || '')}</p>
        <p><strong>Citizenship:</strong> ${escapeHtml(res.guestCitizenship || '')}</p>
        <p><strong>Date of Birth:</strong> ${escapeHtml(res.guestBirthDate || '')}</p>
        <p><strong>Phone Number:</strong> ${escapeHtml(res.guestPhone || '')}</p>
        <p><strong>Email (optional):</strong> ${escapeHtml(res.guestEmail || '')}</p>
        <h4>Accommodation Details</h4>
        <p><strong>Check-in Date:</strong> ${formatDate(res.checkinDate)}</p>
        <p><strong>Check-out Date:</strong> ${formatDate(res.checkoutDate)}</p>
        <p><strong>Room No. / Type:</strong> ${escapeHtml(room ? (room.roomName || room.roomNumber) : '-')} / ${escapeHtml(room?.roomType || '-')}</p>
        <h4>Consent and Rules</h4>
        <p>I have received and read the hotel rules and agree to comply with them;</p>
        <p>I accept responsibility for any damage or loss of room inventory;</p>
        <p>I agree that the hotel may process my personal data solely for service purposes;</p>
        <p>I acknowledge that late checkout or rule violations may result in additional charges.</p>
        <p>â˜ I agree to the terms listed above</p>
        <h4>Signature</h4>
        <p><strong>Guest Signature:</strong> _________________________________</p>
        <p><strong>Date:</strong> _____________________</p>
        <p><strong>Hotel Representative Signature:</strong> __________________.</p>
      `;
      w.document.write(`
        <!DOCTYPE html>
        <html lang="${isKa ? 'ka' : 'en'}">
        <head>
          <meta charset="UTF-8">
          <title>${title}</title>
          <style>
            @page { size: A4; margin: 14mm; }
            body { font-family: Arial, sans-serif; padding: 0; color: #0f172a; font-size: 12px; }
            .consent-form { padding: 14px; border: 1px solid #e2e8f0; }
            h3 { text-align: center; margin-bottom: 10px; font-size: 16px; }
            h4 { margin-top: 10px; margin-bottom: 6px; font-size: 13px; }
            p { margin-bottom: 6px; line-height: 1.35; }
            @media print { .no-print { display: none; } }
          </style>
        </head>
        <body>
          <div class="consent-form">
            <h3>${title}</h3>
            ${consentText}
          </div>
          <div class="no-print" style="margin-top: 16px;"><button onclick="window.print()">${isKa ? 'áƒ‘áƒ”áƒ­áƒ“áƒ•áƒ' : 'Print'}</button></div>
        </body>
        </html>
      `);
      w.document.close();
      w.focus();
      setTimeout(() => w.print(), 120);
    }

    function openRoomEdit(roomId) {
      const room = findRoomById(roomId);
      if (!room) return;
      openModal('custom');
      document.getElementById('modal-title').textContent = 'áƒœáƒáƒ›áƒ áƒ˜áƒ¡ áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ';
      document.getElementById('modal-content').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="text-xs text-gray-500">áƒœáƒáƒ›áƒ”áƒ áƒ˜<input id="editRoomNumber" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(room.roomNumber)}"></label>
          <label class="text-xs text-gray-500">áƒ¡áƒáƒ®áƒ”áƒšáƒ˜<input id="editRoomName" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(room.roomName)}"></label>
          <label class="text-xs text-gray-500">áƒ¢áƒ˜áƒáƒ˜<select id="editRoomType" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">${getRoomTypes().map(t => `<option ${room.roomType===t?'selected':''}>${t}</option>`).join('')}</select></label>
          <label class="text-xs text-gray-500">áƒ¦áƒáƒ›áƒ˜áƒ¡ áƒ¤áƒáƒ¡áƒ˜<input id="editRoomPrice" type="number" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${Number(room.basePrice || 0)}"></label>
          <label class="text-xs text-gray-500">áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ˜<input id="editRoomFloor" type="number" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${Number(room.floor || 1)}"></label>
          <label class="text-xs text-gray-500">áƒ¡áƒáƒ¬áƒáƒšáƒ”áƒ‘áƒ˜<input id="editRoomBeds" type="number" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${Number(room.beds || 1)}"></label>
          <label class="text-xs text-gray-500">áƒ›áƒáƒ¥áƒ¡ áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ”áƒ‘áƒ˜<input id="editRoomMaxGuests" type="number" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${Number(room.maxGuests || 1)}"></label>
          <label class="text-xs text-gray-500">áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜<select id="editRoomStatus" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option ${room.status==='available'?'selected':''}>available</option><option ${room.status==='booked'?'selected':''}>booked</option><option ${room.status==='occupied'?'selected':''}>occupied</option><option ${room.status==='cleaning'?'selected':''}>cleaning</option><option ${room.status==='maintenance'?'selected':''}>maintenance</option></select></label>
        </div>
        <button class="mt-4 px-4 py-2 bg-sky-600 text-white rounded-lg" onclick="saveRoomEdits(${room.id})">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
      `;
    }

    function saveRoomEdits(roomId) {
      const rooms = getRoomsData();
      const idx = rooms.findIndex(r => Number(r.id) === Number(roomId));
      if (idx === -1) return;
      rooms[idx] = {
        ...rooms[idx],
        roomNumber: document.getElementById('editRoomNumber').value.trim(),
        roomName: document.getElementById('editRoomName').value.trim(),
        roomType: document.getElementById('editRoomType').value,
        basePrice: Number(document.getElementById('editRoomPrice').value || 0),
        floor: Number(document.getElementById('editRoomFloor').value || 1),
        beds: Number(document.getElementById('editRoomBeds').value || 1),
        maxGuests: Number(document.getElementById('editRoomMaxGuests').value || 1),
        status: document.getElementById('editRoomStatus').value
      };
      setRoomsData(rooms);
      closeModal();
      showToast('áƒœáƒáƒ›áƒ”áƒ áƒ˜ áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ');
      renderCurrentPage();
    }

    function addRoomFromModal() {
      const roomNumber = document.getElementById('newRoomNumber').value.trim();
      const roomName = document.getElementById('newRoomName').value.trim();
      const roomType = document.getElementById('newRoomType').value;
      const basePrice = Number(document.getElementById('newRoomPrice').value || 0);
      const floor = Number(document.getElementById('newRoomFloor').value || 1);
      const beds = Number(document.getElementById('newRoomBeds').value || 1);
      const maxGuests = Number(document.getElementById('newRoomMaxGuests').value || 1);
      const status = document.getElementById('newRoomStatus').value;
      if (!roomNumber) return showToast('áƒœáƒáƒ›áƒ áƒ˜áƒ¡ áƒœáƒáƒ›áƒ”áƒ áƒ˜ áƒáƒ£áƒªáƒ˜áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ', 'error');
      const rooms = getRoomsData();
      const nextId = rooms.length ? Math.max(...rooms.map(r => Number(r.id))) + 1 : 1;
      rooms.push({ id: nextId, roomNumber, roomName: roomName || `Room ${roomNumber}`, roomType, basePrice, floor, beds, maxGuests, status });
      setRoomsData(rooms);
      closeModal();
      showToast('áƒœáƒáƒ›áƒ”áƒ áƒ˜ áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ');
      renderCurrentPage();
    }

    function addGuestFromModal() {
      const guestName = document.getElementById('newGuestModalName').value.trim();
      const guestPhone = document.getElementById('newGuestModalPhone').value.trim();
      const guestEmail = document.getElementById('newGuestModalEmail').value.trim();
      const guestIdNumber = document.getElementById('newGuestModalId').value.trim();
      const guestCitizenship = document.getElementById('newGuestModalCitizenship').value.trim();
      const guestBirthDate = document.getElementById('newGuestModalBirthDate').value;
      if (!guestName) return showToast('áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ áƒáƒ£áƒªáƒ˜áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ', 'error');
      const guests = getGuestsData();
      guests.push({ guestName, guestPhone, guestEmail, guestIdNumber, guestCitizenship, guestBirthDate, flagged: false });
      setGuestsData(guests);
      closeModal();
      showToast('áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜ áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ');
      renderGuests();
    }

    function openGuestEdit(guestIdNumber) {
      const guests = getGuestsData();
      const idx = guests.findIndex(g => String(g.guestIdNumber || '') === String(guestIdNumber || ''));
      if (idx === -1) return;
      const g = guests[idx];
      openModal('custom');
      document.getElementById('modal-title').textContent = 'áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ˜áƒ¡ áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ';
      document.getElementById('modal-content').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="text-xs text-gray-500">áƒ¡áƒáƒ®áƒ”áƒšáƒ˜<input id="editGuestModalName" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(g.guestName || '')}"></label>
          <label class="text-xs text-gray-500">áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜<input id="editGuestModalPhone" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(g.guestPhone || '')}"></label>
          <label class="text-xs text-gray-500">áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒ<input id="editGuestModalEmail" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(g.guestEmail || '')}"></label>
          <label class="text-xs text-gray-500">áƒáƒ˜áƒ áƒáƒ“áƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜ / áƒáƒáƒ¡áƒáƒáƒ áƒ¢áƒ˜<input id="editGuestModalId" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(g.guestIdNumber || '')}"></label>
          <label class="text-xs text-gray-500">áƒ›áƒáƒ¥áƒáƒšáƒáƒ¥áƒ”áƒáƒ‘áƒ<input id="editGuestModalCitizenship" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(g.guestCitizenship || '')}"></label>
          <label class="text-xs text-gray-500">áƒ“áƒáƒ‘áƒáƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜<input id="editGuestModalBirthDate" type="date" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${escapeHtml(g.guestBirthDate || '')}"></label>
        </div>
        <button class="mt-4 px-4 py-2 bg-sky-600 text-white rounded-lg" onclick="saveGuestEdits('${escapeHtml(g.guestIdNumber || '')}', ${idx})">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
      `;
    }

    function saveGuestEdits(originalId, idxHint) {
      const guests = getGuestsData();
      const idx = Number.isInteger(idxHint) ? idxHint : guests.findIndex(g => String(g.guestIdNumber || '') === String(originalId || ''));
      if (idx === -1) return;
      guests[idx] = {
        ...guests[idx],
        guestName: document.getElementById('editGuestModalName').value.trim(),
        guestPhone: document.getElementById('editGuestModalPhone').value.trim(),
        guestEmail: document.getElementById('editGuestModalEmail').value.trim(),
        guestIdNumber: document.getElementById('editGuestModalId').value.trim(),
        guestCitizenship: document.getElementById('editGuestModalCitizenship').value.trim(),
        guestBirthDate: document.getElementById('editGuestModalBirthDate').value
      };
      setGuestsData(guests);
      closeModal();
      showToast('áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜ áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ');
      renderGuests();
    }

    function addPaymentFromModal() {
      const reservationId = Number(document.getElementById('newPaymentReservationId').value);
      const amount = Number(document.getElementById('newPaymentAmount').value || 0);
      const method = document.getElementById('newPaymentMethod').value;
      const status = document.getElementById('newPaymentStatusField').value;
      const reservations = getReservationsData();
      const reservation = reservations.find(r => Number(r.id) === Number(reservationId));
      if (!reservation) return showToast('áƒáƒ˜áƒ áƒ©áƒ˜áƒ”áƒ— áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜', 'error');
      const payments = getPaymentsData();
      const nextId = Number(getState('nextPaymentId', 1));
      payments.push({ id: nextId, reservationId, guestName: reservation.guestName, amount, method, status, createdAt: new Date().toISOString() });
      setPaymentsData(payments);
      setState('nextPaymentId', nextId + 1);
      reservation.paymentStatus = status;
      setReservationsData(reservations);
      closeModal();
      showToast('áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ');
      renderPayments();
    }

    function openPaymentEdit(paymentId) {
      const payment = getPaymentsData().find(p => Number(p.id) === Number(paymentId));
      if (!payment) return;
      openModal('custom');
      document.getElementById('modal-title').textContent = 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ';
      document.getElementById('modal-content').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="editPaymentAmount" type="number" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${Number(payment.amount || 0)}">
          <select id="editPaymentMethod" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option ${payment.method==='cash'?'selected':''} value="cash">cash</option><option ${payment.method==='card'?'selected':''} value="card">card</option><option ${payment.method==='bank'?'selected':''} value="bank">bank</option></select>
          <select id="editPaymentStatusField" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option value="unpaid" ${payment.status==='unpaid'?'selected':''}>unpaid</option><option value="partial" ${payment.status==='partial'?'selected':''}>partial</option><option value="paid" ${payment.status==='paid'?'selected':''}>paid</option></select>
        </div>
        <button class="mt-4 px-4 py-2 bg-sky-600 text-white rounded-lg" onclick="savePaymentEdits(${payment.id})">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
      `;
    }

    function savePaymentEdits(paymentId) {
      const payments = getPaymentsData();
      const idx = payments.findIndex(p => Number(p.id) === Number(paymentId));
      if (idx === -1) return;
      payments[idx] = {
        ...payments[idx],
        amount: Number(document.getElementById('editPaymentAmount').value || 0),
        method: document.getElementById('editPaymentMethod').value,
        status: document.getElementById('editPaymentStatusField').value
      };
      setPaymentsData(payments);
      const reservations = getReservationsData();
      const r = reservations.find(x => Number(x.id) === Number(payments[idx].reservationId));
      if (r) r.paymentStatus = payments[idx].status;
      setReservationsData(reservations);
      closeModal();
      showToast('áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ');
      renderPayments();
    }

    function printPaymentInvoice(paymentId) {
      const payment = getPaymentsData().find(p => Number(p.id) === Number(paymentId));
      if (!payment) return;
      const reservations = getReservationsData();
      const res = reservations.find(r => Number(r.id) === Number(payment.reservationId));
      if (!res) return;
      printInvoice(res.id);
    }

    function renderChannels() {
      const c = getChannelConfig();
      document.getElementById('page-channels').innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Channel Manager</h2>
          <span class="text-sm px-3 py-1 rounded-full ${c.isConnected ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">${c.isConnected ? 'áƒ“áƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ' : 'áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜áƒ'}</span>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm mb-1">áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜áƒ¡ áƒ áƒ”áƒŸáƒ˜áƒ›áƒ˜</label><select id="ch-mode" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option value="oauth" ${c.connectionMode==='oauth'?'selected':''}>OAuth</option><option value="apiKey" ${c.connectionMode==='apiKey'?'selected':''}>API Key</option></select></div>
            <div><label class="block text-sm mb-1">Proxy URL</label><input id="ch-proxy" value="${escapeHtml(c.proxyUrl)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="https://your-backend.com/channex-proxy"></div>
            <div><label class="block text-sm mb-1">OAuth Start URL</label><input id="ch-start" value="${escapeHtml(c.authStartUrl)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
            <div><label class="block text-sm mb-1">OAuth Status URL</label><input id="ch-status" value="${escapeHtml(c.authStatusUrl)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
            <div><label class="block text-sm mb-1">API Base URL</label><input id="ch-base" value="${escapeHtml(c.apiBaseUrl)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
            <div><label class="block text-sm mb-1">API Key</label><input id="ch-key" value="${escapeHtml(c.apiKey)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
            <div><label class="block text-sm mb-1">Property ID</label><input id="ch-property" value="${escapeHtml(c.propertyId)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
            <div><label class="block text-sm mb-1">Auto Sync (áƒ¬áƒ£áƒ—áƒ˜)</label><input id="ch-interval" type="number" min="5" value="${c.syncIntervalMinutes}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button onclick="saveChannelSettings()" class="px-4 py-2 bg-sky-600 text-white rounded-xl">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
            <button onclick="startChannexOAuth()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl">Channex OAuth áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ</button>
            <button onclick="testChannexConnection()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl">áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜áƒ¡ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜</button>
            <button onclick="syncChannexData('rates')" class="px-4 py-2 bg-amber-500 text-white rounded-xl">Rates Sync</button>
            <button onclick="syncChannexData('reservations')" class="px-4 py-2 bg-amber-500 text-white rounded-xl">Reservations Sync</button>
            <button onclick="disconnectChannex()" class="px-4 py-2 bg-red-600 text-white rounded-xl">áƒ’áƒáƒ—áƒ˜áƒ¨áƒ•áƒ</button>
          </div>
          <div class="text-xs text-gray-500">áƒ‘áƒáƒšáƒ áƒ“áƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ: ${c.connectedAt ? formatDate(c.connectedAt) : '-'} | áƒ‘áƒáƒšáƒ sync: ${c.lastSyncAt ? formatDate(c.lastSyncAt) : '-'}</div>
        </div>
      `;
    }

    function readChannelForm() {
      return {
        connectionMode: document.getElementById('ch-mode').value,
        proxyUrl: document.getElementById('ch-proxy').value.trim(),
        authStartUrl: document.getElementById('ch-start').value.trim(),
        authStatusUrl: document.getElementById('ch-status').value.trim(),
        apiBaseUrl: document.getElementById('ch-base').value.trim(),
        apiKey: document.getElementById('ch-key').value.trim(),
        propertyId: document.getElementById('ch-property').value.trim(),
        syncIntervalMinutes: Number(document.getElementById('ch-interval').value || 15),
        autoSyncEnabled: true
      };
    }

    function saveChannelSettings() {
      const f = readChannelForm();
      setChannelConfig(f);
      showToast('Channel Manager áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ');
      renderChannels();
    }

    async function refreshChannexOAuthConnection() {
      const c = getChannelConfig();
      if (!c.authStatusUrl) throw new Error('OAuth status URL áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ');
      const res = await fetch(c.authStatusUrl, { method: 'GET', credentials: 'include' });
      const text = await res.text();
      const data = text ? JSON.parse(text) : {};
      if (!res.ok) throw new Error(data.message || `${res.status} ${res.statusText}`);
      const connected = !!(data.connected ?? data.isConnected ?? data.active);
      setChannelConfig({
        isConnected: connected,
        connectedAt: connected ? new Date().toISOString() : '',
        propertyId: data.property_id || data.propertyId || c.propertyId || ''
      });
      return connected;
    }

    async function testChannexConnection() {
      try {
        const c = getChannelConfig();
        if (c.connectionMode === 'oauth') {
          const ok = await refreshChannexOAuthConnection();
          showToast(ok ? 'OAuth áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜ áƒ“áƒáƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ“áƒ' : 'OAuth áƒ¯áƒ”áƒ  áƒáƒ áƒáƒ áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ£áƒšáƒ˜', ok ? 'success' : 'warning');
        } else {
          if (!c.apiKey && !c.proxyUrl) throw new Error('API key áƒáƒœ Proxy URL áƒáƒ£áƒªáƒ˜áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ');
          const base = (c.proxyUrl || c.apiBaseUrl || '').replace(/\/$/, '');
          const r = await fetch(`${base}/properties?pagination[limit]=1`, {
            headers: c.apiKey ? { Authorization: `Bearer ${c.apiKey}` } : {},
            credentials: 'include'
          });
          if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
          setChannelConfig({ isConnected: true, connectedAt: new Date().toISOString() });
          showToast('API áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ');
        }
      } catch (e) {
        setChannelConfig({ isConnected: false });
        showToast(`áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ: ${e.message}`, 'error');
      }
      renderChannels();
    }

    function startChannexOAuth() {
      const f = readChannelForm();
      setChannelConfig(f);
      if (!f.authStartUrl) return showToast('OAuth Start URL áƒ¡áƒáƒ•áƒáƒšáƒ“áƒ”áƒ‘áƒ£áƒšáƒáƒ', 'error');
      if (!f.proxyUrl) return showToast('OAuth áƒ áƒ”áƒŸáƒ˜áƒ›áƒ¨áƒ˜ Proxy URL áƒ¡áƒáƒ•áƒáƒšáƒ“áƒ”áƒ‘áƒ£áƒšáƒáƒ', 'error');
      const callbackUrl = `${window.location.origin}${window.location.pathname}?channex_oauth=success`;
      const url = new URL(f.authStartUrl, window.location.origin);
      url.searchParams.set('redirect_uri', callbackUrl);
      url.searchParams.set('return_to', callbackUrl);
      url.searchParams.set('site_origin', window.location.origin);
      url.searchParams.set('site_name', window.location.hostname || 'hotel-site');
      if (f.propertyId) url.searchParams.set('property_id', f.propertyId);
      window.location.href = url.toString();
    }

    async function handleOAuthCallback() {
      const params = new URLSearchParams(window.location.search);
      const status = params.get('channex_oauth');
      const error = params.get('error') || params.get('channex_error');
      if (!status && !error) return;
      try {
        if (error || status === 'error') throw new Error(error || 'OAuth áƒ’áƒáƒ£áƒ¥áƒ›áƒ“áƒ');
        const ok = await refreshChannexOAuthConnection();
        showToast(ok ? 'Channex áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ“áƒ' : 'OAuth áƒ“áƒáƒ‘áƒ áƒ£áƒœáƒ“áƒ, áƒ›áƒáƒ’áƒ áƒáƒ› áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜ áƒ•áƒ”áƒ  áƒ“áƒáƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ“áƒ', ok ? 'success' : 'warning');
      } catch (e) {
        showToast(`OAuth áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ: ${e.message}`, 'error');
      }
      window.history.replaceState({}, document.title, `${window.location.origin}${window.location.pathname}${window.location.hash}`);
    }

    async function syncChannexData(kind) {
      const c = getChannelConfig();
      if (!c.isConnected) return showToast('áƒ¯áƒ”áƒ  áƒ“áƒáƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ— Channex', 'warning');
      const base = (c.proxyUrl || c.apiBaseUrl || '').replace(/\/$/, '');
      const path = kind === 'rates' ? `/room_types?filter[property_id]=${encodeURIComponent(c.propertyId || '')}&pagination[limit]=5` : `/bookings?filter[property_id]=${encodeURIComponent(c.propertyId || '')}&pagination[limit]=20`;
      try {
        const res = await fetch(`${base}${path}`, {
          headers: c.apiKey ? { Authorization: `Bearer ${c.apiKey}` } : {},
          credentials: 'include'
        });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        setChannelConfig({ lastSyncAt: new Date().toISOString() });
        showToast(`${kind} sync áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ“áƒ`);
      } catch (e) {
        showToast(`sync áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ: ${e.message}`, 'error');
      }
      renderChannels();
    }

    function disconnectChannex() {
      setChannelConfig({ isConnected: false, connectedAt: '', lastSyncAt: '', apiKey: '' });
      showToast('Channex áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜ áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜áƒ', 'warning');
      renderChannels();
    }

    function openModal(type) {
      const container = document.getElementById('modal-container');
      const title = document.getElementById('modal-title');
      const content = document.getElementById('modal-content');
      container.classList.remove('hidden');
      if (type === 'new-reservation') {
        title.textContent = 'áƒáƒ®áƒáƒšáƒ˜ áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜';
        const rooms = getRoomsData();
        const today = formatDateISO(new Date());
        content.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input id="newGuestName" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ *">
            <input id="newGuestPhone" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜">
            <input id="newGuestEmail" type="email" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒ">
            <input id="newGuestIdNumber" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒáƒ˜áƒ áƒáƒ“áƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜ / áƒáƒáƒ¡áƒáƒáƒ áƒ¢áƒ˜" onblur="autoFillGuestById()">
            <input id="newGuestCitizenship" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ›áƒáƒ¥áƒáƒšáƒáƒ¥áƒ”áƒáƒ‘áƒ">
            <input id="newGuestBirthDate" type="date" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">
            <select id="newRoomId" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">${rooms.map(r => `<option value="${r.id}">${r.roomName} (${r.roomType})</option>`).join('')}</select>
            <select id="newPaymentStatus" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option value="unpaid">unpaid</option><option value="partial">partial</option><option value="paid">paid</option></select>
            <input id="newCheckinDate" type="date" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${today}">
            <input id="newCheckoutDate" type="date" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="${formatDateISO(addDays(new Date(), 1))}">
          </div>
          <div class="mt-4 flex gap-2">
            <button class="px-4 py-2 bg-sky-600 text-white rounded-lg" onclick="addNewReservation()">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
            <button class="px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg" onclick="closeModal()">áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ</button>
          </div>
        `;
      } else if (type === 'new-room') {
        title.textContent = 'áƒáƒ®áƒáƒšáƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜';
        content.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="text-xs text-gray-500">áƒœáƒáƒ›áƒ”áƒ áƒ˜<input id="newRoomNumber" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ›áƒáƒ’: 101"></label>
            <label class="text-xs text-gray-500">áƒ¡áƒáƒ®áƒ”áƒšáƒ˜<input id="newRoomName" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ›áƒáƒ’: Room 101"></label>
            <label class="text-xs text-gray-500">áƒ¢áƒ˜áƒáƒ˜<select id="newRoomType" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option>Single</option><option>Double</option><option>Triple</option><option>Family</option><option>Suite</option></select></label>
            <label class="text-xs text-gray-500">áƒ¦áƒáƒ›áƒ˜áƒ¡ áƒ¤áƒáƒ¡áƒ˜<input id="newRoomPrice" type="number" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="â‚¾"></label>
            <label class="text-xs text-gray-500">áƒ¡áƒáƒ áƒ—áƒ£áƒšáƒ˜<input id="newRoomFloor" type="number" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="1"></label>
            <label class="text-xs text-gray-500">áƒ¡áƒáƒ¬áƒáƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ áƒáƒáƒ“áƒ”áƒœáƒáƒ‘áƒ<input id="newRoomBeds" type="number" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="1"></label>
            <label class="text-xs text-gray-500">áƒ›áƒáƒ¥áƒ¡áƒ˜áƒ›áƒáƒšáƒ£áƒ áƒ˜ áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ”áƒ‘áƒ˜<input id="newRoomMaxGuests" type="number" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" value="2"></label>
            <label class="text-xs text-gray-500">áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜<select id="newRoomStatus" class="mt-1 w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option>available</option><option>booked</option><option>occupied</option><option>cleaning</option><option>maintenance</option></select></label>
          </div>
          <button class='mt-4 px-4 py-2 bg-sky-600 text-white rounded-lg' onclick='addRoomFromModal()'>áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        `;
      } else if (type === 'new-guest') {
        title.textContent = 'áƒáƒ®áƒáƒšáƒ˜ áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜';
        content.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input id="newGuestModalName" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ *">
            <input id="newGuestModalPhone" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜">
            <input id="newGuestModalEmail" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒ">
            <input id="newGuestModalId" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒáƒ˜áƒ áƒáƒ“áƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜ / áƒáƒáƒ¡áƒáƒáƒ áƒ¢áƒ˜">
            <input id="newGuestModalCitizenship" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ›áƒáƒ¥áƒáƒšáƒáƒ¥áƒ”áƒáƒ‘áƒ">
            <input id="newGuestModalBirthDate" type="date" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">
          </div>
          <button class='mt-4 px-4 py-2 bg-sky-600 text-white rounded-lg' onclick='addGuestFromModal()'>áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        `;
      } else if (type === 'new-payment') {
        title.textContent = 'áƒáƒ®áƒáƒšáƒ˜ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ';
        const reservations = getReservationsData();
        content.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <select id="newPaymentReservationId" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">${reservations.map(r => `<option value="${r.id}">#${r.id} â€¢ ${escapeHtml(r.guestName)} â€¢ áƒáƒ—áƒáƒ®áƒ˜ ${escapeHtml(findRoomById(r.roomId)?.roomNumber || '-')}</option>`).join('')}</select>
            <input id="newPaymentAmount" type="number" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="áƒ—áƒáƒœáƒ®áƒ">
            <select id="newPaymentMethod" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option value="cash">cash</option><option value="card">card</option><option value="bank">bank</option></select>
            <select id="newPaymentStatusField" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option value="unpaid">unpaid</option><option value="partial">partial</option><option value="paid">paid</option></select>
          </div>
          <button class='mt-4 px-4 py-2 bg-sky-600 text-white rounded-lg' onclick='addPaymentFromModal()'>áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        `;
      } else if (type === 'custom') {
        return;
      } else {
        title.textContent = 'áƒ¤áƒáƒ áƒ›áƒ';
        content.innerHTML = '<p class="text-sm text-gray-500">áƒ›áƒáƒšáƒ” áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ”áƒ‘áƒ</p>';
      }
    }

    function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
      document.getElementById('theme-icon').textContent = document.documentElement.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    function card(label, value, emoji) {
      return `<div class='bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700'><div class='text-2xl mb-2'>${emoji}</div><p class='text-sm text-gray-500'>${label}</p><p class='text-3xl font-bold mt-1'>${value}</p></div>`;
    }

    function escapeHtml(v) {
      return String(v || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#39;');
    }

    initialize();
  </script>
</body>
</html>
