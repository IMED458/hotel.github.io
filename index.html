<!DOCTYPE html>
<html lang="ka" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hotel Admin System</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Noto Sans Georgian', 'sans-serif']
          },
          colors: {
            primary: '#0ea5e9',
            secondary: '#64748b',
            success: '#22c55e',
            warning: '#f59e0b',
            danger: '#ef4444',
            dark: '#0f172a'
          }
        }
      }
    };
  </script>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    .app-wrapper { min-height: 100%; overflow: auto; }
    .sidebar { width: 280px; }
    .main-content { margin-left: 280px; }
    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; transition: transform .2s ease; }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0; }
    }
    .toast { animation: slideIn .25s ease; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .modal-overlay { animation: fadeIn .2s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 font-sans text-gray-800 dark:text-gray-100">
  <div class="app-wrapper flex">
    <aside id="sidebar" class="sidebar fixed h-full bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 shadow-sm flex flex-col">
      <div class="p-6 border-b border-gray-100 dark:border-gray-700">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-sky-500 to-blue-600 rounded-xl flex items-center justify-center text-white">ğŸ¨</div>
          <div>
            <h1 id="hotel-name-display" class="font-bold text-lg text-gray-900 dark:text-white">Grand Hotel</h1>
            <p class="text-xs text-gray-500">Admin System</p>
          </div>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-1 overflow-y-auto" id="main-nav"></nav>

      <div class="p-4 border-t border-gray-100 dark:border-gray-700">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-violet-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-semibold">A</div>
          <div class="flex-1">
            <p class="font-medium text-sm text-gray-900 dark:text-white">áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒ¢áƒáƒ áƒ˜</p>
            <p class="text-xs text-gray-500">admin@hotel.ge</p>
          </div>
          <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <span id="theme-icon">ğŸŒ™</span>
          </button>
        </div>
      </div>
    </aside>

    <main class="main-content flex-1 min-h-full">
      <header class="sticky top-0 z-40 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg border-b border-gray-200 dark:border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">â˜°</button>
            <input id="global-search" type="text" placeholder="áƒ«áƒ”áƒ‘áƒœáƒ..." class="px-4 py-2.5 w-64 bg-gray-100 dark:bg-gray-700 border-0 rounded-xl text-sm focus:ring-2 focus:ring-sky-500">
          </div>
          <div class="flex items-center gap-3">
            <button onclick="openModal('new-reservation')" class="px-4 py-2.5 bg-gradient-to-r from-sky-500 to-blue-600 text-white rounded-xl text-sm font-medium">áƒáƒ®áƒáƒšáƒ˜ áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜</button>
            <button class="p-2.5 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700">ğŸ””</button>
          </div>
        </div>
      </header>

      <div id="page-content" class="p-6 space-y-6">
        <section id="page-dashboard" class="page-section"></section>
        <section id="page-calendar" class="page-section hidden"></section>
        <section id="page-rooms" class="page-section hidden"></section>
        <section id="page-reservations" class="page-section hidden"></section>
        <section id="page-guests" class="page-section hidden"></section>
        <section id="page-checkin" class="page-section hidden"></section>
        <section id="page-payments" class="page-section hidden"></section>
        <section id="page-housekeeping" class="page-section hidden"></section>
        <section id="page-pricing" class="page-section hidden"></section>
        <section id="page-channels" class="page-section hidden"></section>
        <section id="page-reports" class="page-section hidden"></section>
        <section id="page-settings" class="page-section hidden"></section>
      </div>
    </main>
  </div>

  <div id="modal-container" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0 bg-black/50" onclick="closeModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden max-h-[90%] flex flex-col">
      <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
        <h3 id="modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">áƒ¤áƒáƒ áƒ›áƒ</h3>
        <button onclick="closeModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">âœ•</button>
      </div>
      <div id="modal-content" class="p-6 overflow-y-auto flex-1"></div>
    </div>
  </div>

  <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <script>
    const NAV_ITEMS = [
      ['dashboard', 'áƒ“áƒ”áƒ¨áƒ‘áƒáƒ áƒ“áƒ˜'], ['calendar', 'áƒ™áƒáƒšáƒ”áƒœáƒ“áƒáƒ áƒ˜ / Timeline'], ['rooms', 'áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ˜'], ['reservations', 'áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜'],
      ['guests', 'áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ”áƒ‘áƒ˜'], ['checkin', 'Check-in / Check-out'], ['payments', 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜ / áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ”áƒ‘áƒ˜'],
      ['housekeeping', 'Housekeeping'], ['pricing', 'áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜ / áƒ¢áƒáƒ áƒ˜áƒ¤áƒ”áƒ‘áƒ˜'], ['channels', 'Channel Manager'],
      ['reports', 'áƒ áƒ”áƒáƒáƒ áƒ¢áƒ”áƒ‘áƒ˜'], ['settings', 'áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜']
    ];

    const defaultConfig = {
      hotel_name: 'Grand Hotel',
      currency_symbol: 'â‚¾',
      primary_color: '#0ea5e9',
      background_color: '#f8fafc',
      text_color: '#1e293b',
      accent_color: '#8b5cf6'
    };

    const DEFAULT_CHANNEL_CONFIG = {
      connectionMode: 'oauth',
      proxyUrl: '',
      apiBaseUrl: 'https://staging.channex.io/api/v1',
      authStartUrl: '/auth/channex/start',
      authStatusUrl: '/auth/channex/status',
      apiKey: '',
      propertyId: '',
      autoSyncEnabled: true,
      syncIntervalMinutes: 15,
      isConnected: false,
      connectedAt: '',
      lastSyncAt: ''
    };

    let config = { ...defaultConfig };
    let allData = [];
    let currentPage = 'dashboard';
    let calendarDate = new Date();
    let calendarView = 'week';

    const dataHandler = {
      onDataChanged(data) {
        allData = Array.isArray(data) ? data : [];
        renderCurrentPage();
      }
    };

    function getChannelConfig() {
      try {
        return { ...DEFAULT_CHANNEL_CONFIG, ...(JSON.parse(localStorage.getItem('channelManagerConfig') || '{}')) };
      } catch {
        return { ...DEFAULT_CHANNEL_CONFIG };
      }
    }

    function setChannelConfig(next) {
      localStorage.setItem('channelManagerConfig', JSON.stringify({ ...getChannelConfig(), ...next }));
    }

    function showToast(message, type = 'success') {
      const c = document.getElementById('toast-container');
      const color = type === 'error' ? 'bg-red-600' : type === 'warning' ? 'bg-amber-500' : 'bg-emerald-600';
      const el = document.createElement('div');
      el.className = `toast ${color} text-white px-4 py-3 rounded-xl shadow-lg text-sm`;
      el.textContent = message;
      c.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    function formatDate(v) {
      if (!v) return '-';
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return '-';
      return d.toLocaleDateString('ka-GE');
    }

    function initNav() {
      const nav = document.getElementById('main-nav');
      nav.innerHTML = NAV_ITEMS.map(([id, label]) => `
        <button onclick="navigateTo('${id}')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700" data-page="${id}">${label}</button>
      `).join('');
    }

    function applyConfig() {
      document.getElementById('hotel-name-display').textContent = config.hotel_name || defaultConfig.hotel_name;
      document.documentElement.style.setProperty('--primary-color', config.primary_color || defaultConfig.primary_color);
    }

    async function initialize() {
      initNav();
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            applyConfig();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              { get: () => cfg.primary_color || defaultConfig.primary_color, set: (v) => window.elementSdk.setConfig({ primary_color: v }) },
              { get: () => cfg.background_color || defaultConfig.background_color, set: (v) => window.elementSdk.setConfig({ background_color: v }) },
              { get: () => cfg.text_color || defaultConfig.text_color, set: (v) => window.elementSdk.setConfig({ text_color: v }) },
              { get: () => cfg.accent_color || defaultConfig.accent_color, set: (v) => window.elementSdk.setConfig({ accent_color: v }) }
            ],
            borderables: []
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['hotel_name', cfg.hotel_name || defaultConfig.hotel_name],
            ['currency_symbol', cfg.currency_symbol || defaultConfig.currency_symbol]
          ])
        });
      }

      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) console.error('Data SDK init failed');
      }

      await handleOAuthCallback();
      applyConfig();
      navigateTo('dashboard');
    }

    function navigateTo(page) {
      currentPage = page;
      document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
      const pageEl = document.getElementById(`page-${page}`);
      if (pageEl) pageEl.classList.remove('hidden');

      document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.remove('bg-sky-50', 'dark:bg-sky-900/20', 'text-sky-700', 'dark:text-sky-400');
        if (el.dataset.page === page) el.classList.add('bg-sky-50', 'dark:bg-sky-900/20', 'text-sky-700', 'dark:text-sky-400');
      });

      document.getElementById('sidebar').classList.remove('open');
      renderCurrentPage();
    }

    function renderCurrentPage() {
      if (currentPage === 'dashboard') return renderDashboard();
      if (currentPage === 'calendar') return renderCalendar();
      if (currentPage === 'rooms') return renderRooms();
      if (currentPage === 'reservations') return renderReservations();
      if (currentPage === 'guests') return renderGuests();
      if (currentPage === 'checkin') return renderCheckin();
      if (currentPage === 'payments') return renderPayments();
      if (currentPage === 'housekeeping') return renderHousekeeping();
      if (currentPage === 'pricing') return renderPricing();
      if (currentPage === 'channels') return renderChannels();
      if (currentPage === 'reports') return renderReports();
      if (currentPage === 'settings') return renderSettings();
    }

    function renderDashboard() {
      const rooms = allData.filter(d => d.type === 'room');
      const reservations = allData.filter(d => d.type === 'reservation');
      const occupied = rooms.filter(r => r.status === 'occupied').length;
      const occupancy = rooms.length ? Math.round((occupied / rooms.length) * 100) : 78;
      const el = document.getElementById('page-dashboard');
      el.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          ${card('áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒáƒ‘áƒ', occupancy + '%', 'ğŸ¨')}
          ${card('áƒ“áƒ¦áƒ˜áƒ£áƒ áƒ˜ áƒ¨áƒ”áƒ›áƒáƒ¡áƒáƒ•áƒáƒšáƒ˜', `${config.currency_symbol}4,250`, 'ğŸ’µ')}
          ${card('áƒ“áƒ¦áƒ”áƒ¡ Check-in', '8', 'ğŸ›¬')}
          ${card('áƒ“áƒ¦áƒ”áƒ¡ Check-out', '5', 'ğŸ›«')}
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
          <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
            <h3 class="font-semibold mb-4">áƒ™áƒ•áƒ˜áƒ áƒ˜áƒ¡ áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒáƒ‘áƒ</h3>
            <div class="h-56 flex items-end gap-3">${[72,68,85,79,91,95,88].map(v=>`<div class='flex-1 bg-sky-100 dark:bg-sky-900/20 rounded-t-lg relative'><div class='absolute bottom-0 inset-x-0 bg-sky-500 rounded-t-lg' style='height:${v}%'></div></div>`).join('')}</div>
          </div>
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
            <h3 class="font-semibold mb-4">áƒ“áƒ¦áƒ˜áƒ¡ áƒáƒ¥áƒ¢áƒ˜áƒ•áƒáƒ‘áƒ</h3>
            <div class="space-y-3 text-sm">
              <div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">Check-in #205</div>
              <div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">áƒáƒ®áƒáƒšáƒ˜ áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜ #1234</div>
              <div class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700/40">áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ</div>
            </div>
          </div>
        </div>
        <div class="mt-6 bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
          <h3 class="font-semibold mb-4">áƒ£áƒáƒ®áƒšáƒ”áƒ¡áƒ˜ áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜</h3>
          <div class="text-sm text-gray-500">${reservations.length ? reservations.length + ' áƒ©áƒáƒœáƒáƒ¬áƒ”áƒ áƒ˜' : 'áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜ áƒ¯áƒ”áƒ  áƒáƒ  áƒáƒ áƒ˜áƒ¡'}</div>
        </div>
      `;
    }

    function renderCalendar() {
      const el = document.getElementById('page-calendar');
      el.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ™áƒáƒšáƒ”áƒœáƒ“áƒáƒ áƒ˜</h2>
            <div class="flex gap-2">
              <button onclick="calendarView='day';renderCalendar()" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">áƒ“áƒ¦áƒ”</button>
              <button onclick="calendarView='week';renderCalendar()" class="px-3 py-2 rounded-lg bg-sky-100 text-sky-700">áƒ™áƒ•áƒ˜áƒ áƒ</button>
              <button onclick="calendarView='month';renderCalendar()" class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">áƒ—áƒ•áƒ”</button>
            </div>
          </div>
          <div class="text-sm text-gray-500">áƒ›áƒ˜áƒ›áƒ“áƒ˜áƒœáƒáƒ áƒ” áƒ áƒ”áƒŸáƒ˜áƒ›áƒ˜: ${calendarView}</div>
          <div class="mt-4 grid grid-cols-8 gap-1 text-xs">${Array.from({length: 56}).map(()=>`<div class='h-10 rounded bg-gray-100 dark:bg-gray-700/50'></div>`).join('')}</div>
        </div>
      `;
    }

    function renderRooms() {
      const rooms = allData.filter(d => d.type === 'room');
      const sample = rooms.length ? rooms : [{ room_number: '101', room_type: 'standard', price: 120 }, { room_number: '202', room_type: 'deluxe', price: 240 }, { room_number: '301', room_type: 'suite', price: 450 }];
      document.getElementById('page-rooms').innerHTML = `
        <div class="flex items-center justify-between mb-4"><h2 class="text-xl font-bold">áƒœáƒáƒ›áƒ áƒ”áƒ‘áƒ˜</h2><button onclick="openModal('new-room')" class="px-4 py-2 bg-sky-600 text-white rounded-xl">áƒáƒ®áƒáƒšáƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜</button></div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${sample.map(r => `
          <div class='bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-100 dark:border-gray-700'>
            <div class='text-2xl font-bold'>${r.room_number || '-'}</div>
            <div class='text-sm text-gray-500 capitalize'>${r.room_type || 'standard'}</div>
            <div class='mt-2 font-semibold'>${config.currency_symbol}${r.price || 0}/áƒ¦áƒáƒ›áƒ”</div>
          </div>`).join('')}</div>
      `;
    }

    function renderReservations() {
      const reservations = allData.filter(d => d.type === 'reservation');
      document.getElementById('page-reservations').innerHTML = `
        <div class="flex items-center justify-between mb-4"><h2 class="text-xl font-bold">áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜</h2><button onclick="openModal('new-reservation')" class="px-4 py-2 bg-sky-600 text-white rounded-xl">áƒáƒ®áƒáƒšáƒ˜ áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜</button></div>
        <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 dark:bg-gray-700/50"><tr><th class="px-4 py-3 text-left">áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜</th><th class="px-4 py-3 text-left">Check-in</th><th class="px-4 py-3 text-left">Check-out</th><th class="px-4 py-3 text-left">áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</th></tr></thead>
            <tbody>${(reservations.slice(0, 12).map(r => `<tr class='border-t border-gray-100 dark:border-gray-700'><td class='px-4 py-3'>${r.guest_name || 'áƒ¡áƒ¢áƒ£áƒ›áƒáƒ áƒ˜'}</td><td class='px-4 py-3'>${formatDate(r.check_in)}</td><td class='px-4 py-3'>${formatDate(r.check_out)}</td><td class='px-4 py-3'>${r.booking_status || 'pending'}</td></tr>`).join('')) || `<tr><td colspan='4' class='px-4 py-6 text-center text-gray-500'>áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡</td></tr>`}</tbody>
          </table>
        </div>
      `;
    }

    function renderGuests() { simplePage('page-guests', 'áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ”áƒ‘áƒ˜', 'áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ”áƒ‘áƒ˜áƒ¡ CRM áƒ˜áƒœáƒ¢áƒ”áƒ áƒ¤áƒ”áƒ˜áƒ¡áƒ˜.'); }
    function renderCheckin() { simplePage('page-checkin', 'Check-in / Check-out', 'áƒ“áƒ¦áƒ˜áƒ¡ áƒáƒáƒ”áƒ áƒáƒªáƒ˜áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ¡áƒáƒ›áƒ£áƒ¨áƒáƒ áƒœáƒáƒ™áƒáƒ“áƒ˜.'); }
    function renderPayments() { simplePage('page-payments', 'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜', 'áƒ˜áƒœáƒ•áƒáƒ˜áƒ¡áƒ”áƒ‘áƒ˜, áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ‘áƒáƒšáƒáƒœáƒ¡áƒ˜.'); }
    function renderHousekeeping() { simplePage('page-housekeeping', 'Housekeeping', 'áƒ“áƒáƒ•áƒáƒšáƒ”áƒ‘áƒ”áƒ‘áƒ˜, áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ”áƒ‘áƒ˜, áƒáƒáƒ¡áƒ£áƒ®áƒ˜áƒ¡áƒ›áƒ’áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒáƒ˜áƒ áƒ”áƒ‘áƒ˜.'); }
    function renderPricing() { simplePage('page-pricing', 'áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜ / áƒ¢áƒáƒ áƒ˜áƒ¤áƒ”áƒ‘áƒ˜', 'áƒ¢áƒáƒ áƒ˜áƒ¤áƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒ˜áƒœáƒáƒ›áƒ˜áƒ£áƒ áƒ˜ áƒ›áƒáƒ áƒ—áƒ•áƒ áƒ¡áƒ”áƒ–áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ®áƒ”áƒ“áƒ•áƒ˜áƒ—.'); }
    function renderReports() { simplePage('page-reports', 'áƒ áƒ”áƒáƒáƒ áƒ¢áƒ”áƒ‘áƒ˜', 'áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒáƒ‘áƒ, ADR, RevPAR áƒ“áƒ áƒ¨áƒ”áƒ›áƒáƒ¡áƒáƒ•áƒšáƒ”áƒ‘áƒ˜.'); }
    function renderSettings() { simplePage('page-settings', 'áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜', 'áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒáƒ¡ áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜, áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ”áƒ‘áƒ˜ áƒ“áƒ áƒáƒáƒšáƒ˜áƒ¢áƒ˜áƒ™áƒ.'); }

    function simplePage(id, title, text) {
      document.getElementById(id).innerHTML = `<div class='bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700'><h2 class='text-xl font-bold mb-2'>${title}</h2><p class='text-gray-500'>${text}</p></div>`;
    }

    function renderChannels() {
      const c = getChannelConfig();
      document.getElementById('page-channels').innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Channel Manager</h2>
          <span class="text-sm px-3 py-1 rounded-full ${c.isConnected ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">${c.isConnected ? 'áƒ“áƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ' : 'áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜áƒ'}</span>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm mb-1">áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜áƒ¡ áƒ áƒ”áƒŸáƒ˜áƒ›áƒ˜</label><select id="ch-mode" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"><option value="oauth" ${c.connectionMode==='oauth'?'selected':''}>OAuth</option><option value="apiKey" ${c.connectionMode==='apiKey'?'selected':''}>API Key</option></select></div>
            <div><label class="block text-sm mb-1">Proxy URL</label><input id="ch-proxy" value="${escapeHtml(c.proxyUrl)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700" placeholder="https://your-backend.com/channex-proxy"></div>
            <div><label class="block text-sm mb-1">OAuth Start URL</label><input id="ch-start" value="${escapeHtml(c.authStartUrl)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
            <div><label class="block text-sm mb-1">OAuth Status URL</label><input id="ch-status" value="${escapeHtml(c.authStatusUrl)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
            <div><label class="block text-sm mb-1">API Base URL</label><input id="ch-base" value="${escapeHtml(c.apiBaseUrl)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
            <div><label class="block text-sm mb-1">API Key</label><input id="ch-key" value="${escapeHtml(c.apiKey)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
            <div><label class="block text-sm mb-1">Property ID</label><input id="ch-property" value="${escapeHtml(c.propertyId)}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
            <div><label class="block text-sm mb-1">Auto Sync (áƒ¬áƒ£áƒ—áƒ˜)</label><input id="ch-interval" type="number" min="5" value="${c.syncIntervalMinutes}" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700"></div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button onclick="saveChannelSettings()" class="px-4 py-2 bg-sky-600 text-white rounded-xl">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
            <button onclick="startChannexOAuth()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl">Channex OAuth áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ</button>
            <button onclick="testChannexConnection()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl">áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜áƒ¡ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜</button>
            <button onclick="syncChannexData('rates')" class="px-4 py-2 bg-amber-500 text-white rounded-xl">Rates Sync</button>
            <button onclick="syncChannexData('reservations')" class="px-4 py-2 bg-amber-500 text-white rounded-xl">Reservations Sync</button>
            <button onclick="disconnectChannex()" class="px-4 py-2 bg-red-600 text-white rounded-xl">áƒ’áƒáƒ—áƒ˜áƒ¨áƒ•áƒ</button>
          </div>
          <div class="text-xs text-gray-500">áƒ‘áƒáƒšáƒ áƒ“áƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ: ${c.connectedAt ? formatDate(c.connectedAt) : '-'} | áƒ‘áƒáƒšáƒ sync: ${c.lastSyncAt ? formatDate(c.lastSyncAt) : '-'}</div>
        </div>
      `;
    }

    function readChannelForm() {
      return {
        connectionMode: document.getElementById('ch-mode').value,
        proxyUrl: document.getElementById('ch-proxy').value.trim(),
        authStartUrl: document.getElementById('ch-start').value.trim(),
        authStatusUrl: document.getElementById('ch-status').value.trim(),
        apiBaseUrl: document.getElementById('ch-base').value.trim(),
        apiKey: document.getElementById('ch-key').value.trim(),
        propertyId: document.getElementById('ch-property').value.trim(),
        syncIntervalMinutes: Number(document.getElementById('ch-interval').value || 15),
        autoSyncEnabled: true
      };
    }

    function saveChannelSettings() {
      const f = readChannelForm();
      setChannelConfig(f);
      showToast('Channel Manager áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ');
      renderChannels();
    }

    async function refreshChannexOAuthConnection() {
      const c = getChannelConfig();
      if (!c.authStatusUrl) throw new Error('OAuth status URL áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ');
      const res = await fetch(c.authStatusUrl, { method: 'GET', credentials: 'include' });
      const text = await res.text();
      const data = text ? JSON.parse(text) : {};
      if (!res.ok) throw new Error(data.message || `${res.status} ${res.statusText}`);
      const connected = !!(data.connected ?? data.isConnected ?? data.active);
      setChannelConfig({
        isConnected: connected,
        connectedAt: connected ? new Date().toISOString() : '',
        propertyId: data.property_id || data.propertyId || c.propertyId || ''
      });
      return connected;
    }

    async function testChannexConnection() {
      try {
        const c = getChannelConfig();
        if (c.connectionMode === 'oauth') {
          const ok = await refreshChannexOAuthConnection();
          showToast(ok ? 'OAuth áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜ áƒ“áƒáƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ“áƒ' : 'OAuth áƒ¯áƒ”áƒ  áƒáƒ áƒáƒ áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ£áƒšáƒ˜', ok ? 'success' : 'warning');
        } else {
          if (!c.apiKey && !c.proxyUrl) throw new Error('API key áƒáƒœ Proxy URL áƒáƒ£áƒªáƒ˜áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ');
          const base = (c.proxyUrl || c.apiBaseUrl || '').replace(/\/$/, '');
          const r = await fetch(`${base}/properties?pagination[limit]=1`, {
            headers: c.apiKey ? { Authorization: `Bearer ${c.apiKey}` } : {},
            credentials: 'include'
          });
          if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
          setChannelConfig({ isConnected: true, connectedAt: new Date().toISOString() });
          showToast('API áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ');
        }
      } catch (e) {
        setChannelConfig({ isConnected: false });
        showToast(`áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ: ${e.message}`, 'error');
      }
      renderChannels();
    }

    function startChannexOAuth() {
      const f = readChannelForm();
      setChannelConfig(f);
      if (!f.authStartUrl) return showToast('OAuth Start URL áƒ¡áƒáƒ•áƒáƒšáƒ“áƒ”áƒ‘áƒ£áƒšáƒáƒ', 'error');
      if (!f.proxyUrl) return showToast('OAuth áƒ áƒ”áƒŸáƒ˜áƒ›áƒ¨áƒ˜ Proxy URL áƒ¡áƒáƒ•áƒáƒšáƒ“áƒ”áƒ‘áƒ£áƒšáƒáƒ', 'error');
      const callbackUrl = `${window.location.origin}${window.location.pathname}?channex_oauth=success`;
      const url = new URL(f.authStartUrl, window.location.origin);
      url.searchParams.set('redirect_uri', callbackUrl);
      url.searchParams.set('return_to', callbackUrl);
      url.searchParams.set('site_origin', window.location.origin);
      url.searchParams.set('site_name', window.location.hostname || 'hotel-site');
      if (f.propertyId) url.searchParams.set('property_id', f.propertyId);
      window.location.href = url.toString();
    }

    async function handleOAuthCallback() {
      const params = new URLSearchParams(window.location.search);
      const status = params.get('channex_oauth');
      const error = params.get('error') || params.get('channex_error');
      if (!status && !error) return;
      try {
        if (error || status === 'error') throw new Error(error || 'OAuth áƒ’áƒáƒ£áƒ¥áƒ›áƒ“áƒ');
        const ok = await refreshChannexOAuthConnection();
        showToast(ok ? 'Channex áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ“áƒ' : 'OAuth áƒ“áƒáƒ‘áƒ áƒ£áƒœáƒ“áƒ, áƒ›áƒáƒ’áƒ áƒáƒ› áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜ áƒ•áƒ”áƒ  áƒ“áƒáƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ“áƒ', ok ? 'success' : 'warning');
      } catch (e) {
        showToast(`OAuth áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ: ${e.message}`, 'error');
      }
      window.history.replaceState({}, document.title, `${window.location.origin}${window.location.pathname}${window.location.hash}`);
    }

    async function syncChannexData(kind) {
      const c = getChannelConfig();
      if (!c.isConnected) return showToast('áƒ¯áƒ”áƒ  áƒ“áƒáƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ— Channex', 'warning');
      const base = (c.proxyUrl || c.apiBaseUrl || '').replace(/\/$/, '');
      const path = kind === 'rates' ? `/room_types?filter[property_id]=${encodeURIComponent(c.propertyId || '')}&pagination[limit]=5` : `/bookings?filter[property_id]=${encodeURIComponent(c.propertyId || '')}&pagination[limit]=20`;
      try {
        const res = await fetch(`${base}${path}`, {
          headers: c.apiKey ? { Authorization: `Bearer ${c.apiKey}` } : {},
          credentials: 'include'
        });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        setChannelConfig({ lastSyncAt: new Date().toISOString() });
        showToast(`${kind} sync áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ“áƒ`);
      } catch (e) {
        showToast(`sync áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ: ${e.message}`, 'error');
      }
      renderChannels();
    }

    function disconnectChannex() {
      setChannelConfig({ isConnected: false, connectedAt: '', lastSyncAt: '', apiKey: '' });
      showToast('Channex áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ˜ áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜áƒ', 'warning');
      renderChannels();
    }

    function openModal(type) {
      const container = document.getElementById('modal-container');
      const title = document.getElementById('modal-title');
      const content = document.getElementById('modal-content');
      container.classList.remove('hidden');
      if (type === 'new-reservation') {
        title.textContent = 'áƒáƒ®áƒáƒšáƒ˜ áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜';
        content.innerHTML = `<div class='space-y-3'><input class='w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700' placeholder='áƒ¡áƒ¢áƒ£áƒ›áƒ áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜'><input type='date' class='w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700'><input type='date' class='w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700'><button class='px-4 py-2 bg-sky-600 text-white rounded-lg' onclick='showToast("áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ");closeModal()'>áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button></div>`;
      } else if (type === 'new-room') {
        title.textContent = 'áƒáƒ®áƒáƒšáƒ˜ áƒœáƒáƒ›áƒ”áƒ áƒ˜';
        content.innerHTML = `<div class='space-y-3'><input class='w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700' placeholder='áƒœáƒáƒ›áƒ”áƒ áƒ˜ (áƒ›áƒáƒ’. 101)'><select class='w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700'><option>standard</option><option>deluxe</option><option>suite</option></select><button class='px-4 py-2 bg-sky-600 text-white rounded-lg' onclick='showToast("áƒœáƒáƒ›áƒ”áƒ áƒ˜ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ");closeModal()'>áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button></div>`;
      } else {
        title.textContent = 'áƒ¤áƒáƒ áƒ›áƒ';
        content.innerHTML = '<p class="text-sm text-gray-500">áƒ›áƒáƒšáƒ” áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ”áƒ‘áƒ</p>';
      }
    }

    function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
      document.getElementById('theme-icon').textContent = document.documentElement.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    function card(label, value, emoji) {
      return `<div class='bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-100 dark:border-gray-700'><div class='text-2xl mb-2'>${emoji}</div><p class='text-sm text-gray-500'>${label}</p><p class='text-3xl font-bold mt-1'>${value}</p></div>`;
    }

    function escapeHtml(v) {
      return String(v || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#39;');
    }

    initialize();
  </script>
</body>
</html>
